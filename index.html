<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ìŠ¤í‹°ë¸Œ ê²Œì„</title>
  <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
  <style>
    body {
      background-color: #000;
      color: #fff;
      font-family: 'VT323', 'Neoë‘¥ê·¼ëª¨', sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 90vh;
      flex-direction: column;
      text-align: center;
    }

.chapter-btn,
.dropdown-content,
#promptInput,
#responseBox,
button,
p,
h1, h2, h3 {
  font-family: 'VT323', 'Neoë‘¥ê·¼ëª¨', sans-serif;
}

    h1 {
      font-size: 8rem;
      color: #0ff;
      text-shadow: 0 0 10px #0ff, 0 0 20px #0ff;
      margin-bottom: 40px;
    }

    .game-container {
      display: flex;
      flex-direction: column;
      background-color: #111;
      padding: 40px;
      border-radius: 10px;
      box-shadow: 0 0 15px #0ff;
      width: 80%;
      max-width: 1200px;
      height: 55%;
      text-align: left;
    }

    .gif-container {
      margin-top: 10px;
      width: 100%;
      max-width: 300px;
      margin-right: 40px;
    }

    .gif-container img {
      width: 100%;
      height: auto;
      object-fit: cover;
      border-radius: 8px;
      box-shadow: 0 0 10px #0ff;
      border: 2px solid #0ff;
      color: #0ff;
    }

    .status-container {
      padding: 10px;
      font-size: 1.3rem;
      text-align: left;
      width: 100%;
      max-width: 300px;
    }

    #statusText {
      margin-top: 20px;
      font-size: 1.5rem;
      color: #0ff;
      text-shadow: 0 0 5px #0ff;
    }

    .content-container {
      display: flex;
      flex: 1;
      width: 100%;
    }

    .chat-container {
      flex: 1;
      display: flex;
      margin-top: 10px;
      flex-direction: column;
    }

    .response-box {
      padding: 20px;
      background-color: #222;
      border: 2px solid #0ff;
      color: #0ff;
      font-size: 1.5rem;
      text-align: left;
      box-shadow: 0 0 10px #0ff;
      height: 480px;
      overflow-y: auto;
      white-space: pre-wrap;
      border-radius: 8px;
    }

    .input-container {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      margin-top: 30px;
      gap: 10px;
      width: 100%;
    }

    .prompt-input {
      background: #222;
      border: 2px solid #0ff;
      color: #0ff;
      padding: 12px 20px;
      font-size: 1.5rem;
      flex: 1;
      border-radius: 5px;
      letter-spacing: 2px;
    }

    .submit-btn, .reset-btn {
      background: #0ff;
      color: #000;
      border: 2px solid #0ff;
      padding: 12px 20px;
      font-size: 1.2rem;
      cursor: pointer;
      transition: 0.3s ease;
      font-weight: bold;
      border-radius: 5px;
    }

    .submit-btn:hover, .reset-btn:hover {
      background: #ff00ff;
      box-shadow: 0 0 15px #ff00ff;
      color: #fff;
    }

    .message {
      margin-bottom: 8px;
    }

    .steve {
      color: #1e90ff;
    }

    .user {
      color: #ffffff;
    }

    .narration {
      font-style: italic;
      color: #ff0;
      margin-bottom: 10px;
    }

    .chapter-dropdown {
      position: absolute;
      top: 60px;
      left: 80px;
      z-index: 1000;
      display: none; /* ì´ ì¤„ ì¶”ê°€ë¨ - ì±•í„° ì„ íƒ ë²„íŠ¼ ìˆ¨ê¹€ */
    }

    #next-chapter-btn {
      margin-top: 40px;
      padding: 12px 24px;
      font-family: 'VT323', 'Neoë‘¥ê·¼ëª¨', sans-serif;
      font-size: 1.5rem;
      background: #0ff;
      color: #000;
      border: 2px solid #0ff;
      border-radius: 5px;
      cursor: pointer;
      opacity: 1;
      transition: opacity 0.5s;
    }
    
    #next-chapter-btn:hover {
      background: #ff00ff;
      color: #fff;
    }

    .dropdown-content {
      position: absolute;
      z-index: 9999;
      display: none;
      background-color: #111;
      border: 2px solid #0ff;
      border-top: none;
      width: 200px;
      top: 100%;
      left: 0;
      font-size: 1.1rem;
    }

    .dropdown-content div {
      color: #0ff;
      padding: 10px;
      cursor: pointer;
      border-top: 1px solid #0ff;
    }

    .dropdown-content div:hover {
      background-color: #00f;
      color: #fff;
    }

    /* í´ë¦¬ì–´ ì˜¤ë²„ë ˆì´ */
    #chapter-transition-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(0, 0, 0, 0.8);
      display: none; /* ì²˜ìŒì—” ìˆ¨ê¹€ */
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      opacity: 0;
      transition: opacity 0.5s ease-in-out;
      pointer-events: none;
    }

    #chapter-transition-text {
      font-size: 100px;
      color: #0ff;
      margin-bottom: 20px;
      font-family: 'VT323', monospace;
    }

    @keyframes slideIn {
      0%   { transform: translateY(100%); opacity: 0; }
      40%  { transform: translateY(0); opacity: 1; }
      100% { transform: translateY(0); opacity: 1; }
    }

    #game-over-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: black;
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 999;
      font-family: 'VT323', monospace;
    }

    #game-over-text {
      font-size: 80px;
      color: #FF4C4C;
      text-shadow: 0 0 10px #FF4C4C, 0 0 20px #FF4C4C;
      margin-bottom: 10px;
    }

    #game-over-message {
      font-size: 24px;
      color: #FF4C4C;
      margin-bottom: 30px;
      text-shadow: 0 0 5px #FF4C4C;
    }

    #retry-btn {
      margin-top: 40px;
      padding: 12px 24px;
      font-family: 'VT323', 'Neoë‘¥ê·¼ëª¨', sans-serif;
      font-size: 1.5rem;
      background: #FF4C4C;
      color: #000;
      border: 2px solid #FF4C4C;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s, color 0.3s;
    }

    #retry-btn:hover {
      background: #fff;
      color: #FF4C4C;
    }

    .choice-container {
  margin-top: 20px;
  display: flex;
  flex-direction: row; /* ê°€ë¡œ ë°©í–¥ìœ¼ë¡œ ì •ë ¬ */
  flex-wrap: wrap; /* í•„ìš”ì‹œ ì¤„ë°”ê¿ˆ */
  gap: 10px; /* ë²„íŠ¼ ì‚¬ì´ ê°„ê²© */
  justify-content: flex-start; /* ì™¼ìª½ ì •ë ¬ */
}

.choice-btn {
  background-color: #0ff;
  color: #000;
  padding: 10px 15px;
  border: none;
  border-radius: 5px;
  margin: 0;
  cursor: pointer;
  font-size: 16px;
  font-family: 'VT323', 'Neoë‘¥ê·¼ëª¨', sans-serif;
}

.choice-btn:hover {
  background-color: #ff00ff;
  color: #fff;
}

#sequenceDisplay {
  display: flex;
  flex-direction: row;
  gap: 10px;
  margin-top: 10px;
  padding: 5px 0;
  font-size: 20px;
  color: #00ffff;
  font-family: 'VT323', monospace;
}

#achievementPopup {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: #0ff;
  color: rgb(0, 0, 0);
  padding: 0 12px;
  border-radius: 8px;
  font-family: 'VT323', 'Neoë‘¥ê·¼ëª¨', sans-serif;
  font-size: 14px;
  box-shadow: 0 0 10px rgba(0,0,0,0.5);
  transform: translateY(100px);
  opacity: 0;
  transition: all 0.5s ease;
  z-index: 100;
  max-width: 280px;
  height: 50px;
  line-height: 50px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  text-align: center;
}

#achievementPopup.show {
  transform: translateY(0);
  opacity: 1;
}

  </style>
</head>
<body>
  <!-- ì±•í„° ì„ íƒ ë²„íŠ¼ì€ ìˆ¨ê¸°ì§€ë§Œ ì‚­ì œí•˜ì§€ ì•ŠìŒ -->
  <div class="chapter-dropdown">
    <button id="chapterBtn" class="chapter-btn" onclick="toggleDropdown()">â–¼ Chapter ì„ íƒ</button>
    <div class="dropdown-content" id="chapterList">
      <div onclick="switchChapter(1)">Chapter 1</div>
      <div onclick="switchChapter(2)">Chapter 2</div>
    </div>
  </div>

  <h1>SAVE STEVE!</h1>
  <div class="game-container">
    <div class="content-container">
      <div class="gif-container">
        <img id="sceneImage" src="Save-steve.gif" alt="Game Image">
        <div class="status-container">
          <p id="statusText">ìƒíƒœ: ìŠ¤í‹°ë¸ŒëŠ” ì•„ë¬´ë ‡ì§€ ì•Šì€ ê²ƒ ê°™ìŠµë‹ˆë‹¤.</p>
        </div>
      </div>
      <div class="chat-container">
        <div class="response-box" id="responseBox"></div>
        <div class="input-container">
          <input type="text" class="prompt-input" id="promptInput" placeholder="í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”." onkeypress="handleKeyPress(event)" />
          <button class="submit-btn" onclick="generateResponse()">Send</button>
          <button class="reset-btn" onclick="resetChat()">Reset</button>
        </div>
      </div>
    </div>
  </div>

  <div id="chapter-transition-overlay">
    <div id="chapter-transition-text">CLEAR</div>
    <button id="next-chapter-btn">ë‹¤ìŒ ì±•í„°ë¡œ â–¶</button>
  </div>

  <div id="game-over-overlay">
    <div id="game-over-text">GAME OVER</div>
    <p id="game-over-message">ëŒ€í™”ë¥¼ ì´ì–´ê°ˆ ìˆ˜ ì—†ë‹¤ëŠ” ê²Œ ìŠ¬í”„ë„¤ìš”.</p>
    <button id="retry-btn">ë‹¤ì‹œí•˜ê¸°</button>
  </div>

  <div id="achievementPopup"></div>

<script>
    let hasKey = false;
    let boxOpened = false;
    let safeOpened = false;
    let currentChapter = 1;
    let nextChapterNumber = 2;
    // localStorageì—ì„œ í”Œë ˆì´ì–´ ì´ë¦„ ê°€ì ¸ì˜¤ê¸° (ê¸°ë³¸ê°’: 'í”Œë ˆì´ì–´')
    let playerName = localStorage.getItem('playerName') || 'í”Œë ˆì´ì–´';
    let currentSequence = [];
  
    // í”Œë ˆì´ì–´ ì´ë¦„ ì„¤ì • í•¨ìˆ˜
    function setPlayerName(name) {
        if (name && name.trim() !== '') {
            playerName = name.trim();
            localStorage.setItem('playerName', playerName);
            console.log(`í”Œë ˆì´ì–´ ì´ë¦„ ì„¤ì •ë¨: ${playerName}`);
        }
    }

    // í”Œë ˆì´ì–´ ì´ë¦„ ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜
    function getPlayerName() {
        return playerName || 'í”Œë ˆì´ì–´';
    }

    // 5ì´ˆê°„ í”Œë ˆì´ì–´ ì´ë¦„ í‘œì‹œ í•¨ìˆ˜
    function showTextForFiveSeconds() {
        const textElement = document.createElement('div');
        textElement.className = 'text-overlay';
        textElement.textContent = `[${getPlayerName()}]`;
        textElement.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 16px;
            z-index: 1000;
            animation: fadeInOut 5s forwards;
        `;
        
        // CSS ì• ë‹ˆë©”ì´ì…˜ì´ ì—†ë‹¤ë©´ ì¶”ê°€
        if (!document.querySelector('#textOverlayStyle')) {
            const style = document.createElement('style');
            style.id = 'textOverlayStyle';
            style.textContent = `
                @keyframes fadeInOut {
                    0% { opacity: 0; transform: translateX(20px); }
                    10% { opacity: 1; transform: translateX(0); }
                    90% { opacity: 1; transform: translateX(0); }
                    100% { opacity: 0; transform: translateX(20px); }
                }
            `;
            document.head.appendChild(style);
        }
        
        document.body.appendChild(textElement);
        setTimeout(() => {
            if (textElement.parentNode) {
                textElement.remove();
            }
        }, 5000);
    }
  
    function switchChapter(chapterNumber) {
      currentChapter = chapterNumber;
      const chapterBtn = document.getElementById("chapterBtn");
      chapterBtn.textContent = `Chapter ${currentChapter}`;
      const responseBox = document.getElementById("responseBox");
      responseBox.innerHTML = '';
      displayMessage('SYSTEM', `ì±•í„° ${currentChapter}ë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'narration');
      hideDropdown();
      document.getElementById("sceneImage").src = 'Save-steve.gif';
      updateStatusText('Save-steve.gif');
      hideOverlayAndTransition();
      
      // ì±•í„° ì „í™˜ ì‹œ í”Œë ˆì´ì–´ ì´ë¦„ í‘œì‹œ
      showTextForFiveSeconds();
    }
  
    function toggleDropdown() {
      const dropdown = document.getElementById("chapterList");
      dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
    }
  
    function hideDropdown() {
      document.getElementById("chapterList").style.display = 'none';
    }
  
    function updateStatusText(imageSrc) {
        const statusText = document.getElementById("statusText");
        const image = document.getElementById("sceneImage");

        // íŒŒì¼ëª… ì¶”ì¶œ (ê²½ë¡œì™€ í™•ì¥ì ì œê±°)
        let filename = imageSrc.split('/').pop().split('.')[0];
        
        console.log(`ì›ë³¸ imageSrc: ${imageSrc}`);
        console.log(`ì¶”ì¶œëœ filename: ${filename}`);

        if (filename === 'Save-steve') {
            image.src = `Save-steve.gif?${new Date().getTime()}`;
            statusText.textContent = 'ìƒíƒœ: ìŠ¤í‹°ë¸ŒëŠ” ì•„ë¬´ë ‡ì§€ ì•Šì€ ê²ƒ ê°™ìŠµë‹ˆë‹¤.';
            return;
        }

        // ì„œë²„ì—ì„œ 'images/hap.gif' í˜•ì‹ìœ¼ë¡œ ì˜¤ëŠ” ê²½ìš° ì²˜ë¦¬
        let finalImageSrc;
        if (imageSrc.startsWith('images/')) {
            // ì´ë¯¸ images/ ê²½ë¡œê°€ í¬í•¨ëœ ê²½ìš° ê·¸ëŒ€ë¡œ ì‚¬ìš©
            finalImageSrc = `${imageSrc}?${new Date().getTime()}`;
        } else {
            // images/ ê²½ë¡œê°€ ì—†ëŠ” ê²½ìš° ì¶”ê°€
            finalImageSrc = `images/${filename}.gif?${new Date().getTime()}`;
        }
        
        console.log(`ìµœì¢… ì´ë¯¸ì§€ ê²½ë¡œ: ${finalImageSrc}`);

        // ì´ë¯¸ì§€ ë¡œë“œ ì˜¤ë¥˜ ì²˜ë¦¬
        image.onerror = function () {
            console.log(`GIF ë¡œë“œ ì‹¤íŒ¨: ${finalImageSrc}`);
            // PNG ëŒ€ì•ˆ ì‹œë„
            const pngSrc = imageSrc.startsWith('images/') ? 
                `images/${filename}.png?${new Date().getTime()}` : 
                `${filename}.png?${new Date().getTime()}`;
            
            image.onerror = function() {
                console.log(`PNGë„ ë¡œë“œ ì‹¤íŒ¨: ${pngSrc}`);
                // ê¸°ë³¸ ì´ë¯¸ì§€ë¡œ ëŒ€ì²´
                image.src = 'Save-steve.gif';
                statusText.textContent = 'ìƒíƒœ: ìŠ¤í‹°ë¸ŒëŠ” ì•„ë¬´ë ‡ì§€ ì•Šì€ ê²ƒ ê°™ìŠµë‹ˆë‹¤.';
            };
            image.src = pngSrc;
        };

        // ì´ë¯¸ì§€ ë¡œë“œ ì„±ê³µ ì²˜ë¦¬
        image.onload = function() {
            console.log(`ì´ë¯¸ì§€ ë¡œë“œ ì„±ê³µ: ${image.src}`);
        };

        image.src = finalImageSrc;

        // ìƒíƒœ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        switch (filename) {
            case 'ang': statusText.textContent = 'ìƒíƒœ: í™”ë‚¨'; break;
            case 'cold': statusText.textContent = 'ìƒíƒœ: ì¶”ì›€'; break;
            case 'hap': statusText.textContent = 'ìƒíƒœ: í–‰ë³µ'; break;
            case 'sad': statusText.textContent = 'ìƒíƒœ: ìŠ¬í””'; break;
            case 'sup': statusText.textContent = 'ìƒíƒœ: ë†€ëŒ'; break;
            default: statusText.textContent = 'ìƒíƒœ: ìŠ¤í‹°ë¸ŒëŠ” ì•„ë¬´ë ‡ì§€ ì•Šì€ ê²ƒ ê°™ìŠµë‹ˆë‹¤.';
        }
    }
    
    function resetChat() {
      currentChapter = 1;
      boxOpened = false; // ë¦¬ì…‹ ì‹œ ìƒì ìƒíƒœ ì´ˆê¸°í™”
      safeOpened = false; // ê¸ˆê³  ìƒíƒœë„ ì´ˆê¸°í™”
      document.getElementById("responseBox").innerHTML = '';
      document.getElementById("sceneImage").src = 'Save-steve.gif';
      updateStatusText('Save-steve.gif');
      displayMessage('SYSTEM', 'ì´ˆê¸°í™” ì™„ë£Œ.', 'narration');
      hideDropdown();
      hideOverlayAndTransition();
    }
  
    async function generateResponse() {
      const message = document.getElementById("promptInput").value.trim();
      if (!message) return;
  
      displayMessage('ë‚˜', message, 'user');
  
      if (message.toLowerCase() === 'reset') {
        resetChat();
        return;
      }
  
      if (message.includes('0')) {
        displayMessage('ìŠ¤í‹°ë¸Œ', 'ë‹¤ìŒìœ¼ë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤. ë‹¹ì‹ ì€ ì´ë¯¸ í”Œë ˆì´ë¥¼ í•´ë³¸ì ì´ ìˆë‚˜ìš”?', 'steve');
        await new Promise(r => setTimeout(r, 2000));
        showOverlayAndButton(currentChapter + 1);
        document.getElementById("promptInput").value = '';
        return;
      }

      if (message.includes('ì—´ì')) {
        displayMessage('ë‚˜ë ˆì´ì…˜', 'ë¬¸ì´ ì—´ë ¸ìŠµë‹ˆë‹¤. ë‹¤ìŒ ë°©ìœ¼ë¡œ ì´ë™í•´ì£¼ì„¸ìš”.', 'narration');
        await new Promise(r => setTimeout(r, 2000));
        showOverlayAndButton(currentChapter + 1);
        document.getElementById("promptInput").value = '';
        return;
      }
  
      // "ìƒì?"ì— ëŒ€í•œ íŠ¹ìˆ˜ ì²˜ë¦¬
      const boxKeywords = ["ìƒì", "ìƒì?", "ë¬´ìŠ¨ìƒì", "ë¬´ìŠ¨ìƒì?", "ë¬´ìŠ¨ ìƒì", "ë¬´ìŠ¨ ìƒì?", "ì–´ë–¤ìƒì", "ì–´ë–¤ìƒì?", "ì–´ë–¤ ìƒì", "ì–´ë–¤ ìƒì?"];
      if (boxKeywords.includes(message) && !boxOpened) {
        displayMessage('ìŠ¤í‹°ë¸Œ', 'ì‘ì€ ë‚˜ë¬´ ìƒìì˜ˆìš”. ì´ ìƒìë¥¼ ì—´ì–´ë³¼ê¹Œìš”?', 'steve');
  
        setTimeout(() => {
          const choiceContainer = document.createElement('div');
          choiceContainer.classList.add('choice-container');
          choiceContainer.innerHTML = `
            <button class="choice-btn" onclick="handleChoice('ì—´ì–´ë³´ì')">ì—´ì–´ë³´ì</button>
            <button class="choice-btn" onclick="handleChoice('ì—´ì§€ë§ì')">ì—´ì§€ë§ì</button>
          `;
          document.getElementById("responseBox").appendChild(choiceContainer);
          document.getElementById("responseBox").scrollTop = responseBox.scrollHeight;
        }, 2000);
  
        return;
      } else if (boxKeywords.includes(message) && boxOpened) {
        displayMessage('ìŠ¤í‹°ë¸Œ', 'ê·¸ ìƒìëŠ” ì´ë¯¸ í™•ì¸í–ˆì–´ìš”. ì£¼ë³€ì„ í•œ ë²ˆ ë” ì‚´í´ë³¼ê¹Œìš”?', 'steve');
        return;
      }
  
      //ì—´ì‡ 
      const keyKeywords = ["ì—´ì‡ ", "í‚¤", "key"];
      const doorKeywords = ["ë¬¸ ì—´ê¸°", "ë¬¸ì„ ì—´ë‹¤", "ë¬¸ ì—´ì–´", "ë¬¸ì„ ì—´ì–´", "ë¬¸ì„ ì—´ì–´ë¼", "ì—´ì‡ ë¡œ ë¬¸ì„", "ì—´ì‡ ë¡œ ë¬¸ ì—´ê¸°"];
      
      // ì—´ì‡  ë°œê²¬ ì²˜ë¦¬
      if (keyKeywords.some(keyword => message.toLowerCase().includes(keyword)) && safeOpened && !hasKey) {
        hasKey = true;
        displayMessage('ìŠ¤í‹°ë¸Œ', 'ì—´ì‡ ë¥¼ ì°¾ì•˜ì–´ìš”! ì´ì œ ë¬¸ì„ ì—´ ìˆ˜ ìˆì„ ê²ƒ ê°™ìŠµë‹ˆë‹¤.', 'steve');
        return;
      }
      
      // ì—´ì‡ ë¡œ ë¬¸ ì—´ê¸° ì²˜ë¦¬
      if (doorKeywords.some(keyword => message.includes(keyword)) && hasKey) {
        displayMessage('ìŠ¤í‹°ë¸Œ', 'ì—´ì‡ ë¡œ ë¬¸ì„ ì—´ì—ˆì–´ìš”! ìš°ë¦¬ëŠ” íƒˆì¶œì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤!', 'steve');
        setTimeout(() => showClearScreen(), 1500);
        return;
      }

      // Clear í™”ë©´ í‘œì‹œ í•¨ìˆ˜ ì¶”ê°€
      function showClearScreen() {
        const overlay = document.getElementById("chapter-transition-overlay");
        const text = document.getElementById("chapter-transition-text");
        const nextBtn = document.getElementById("next-chapter-btn");
        
        // í…ìŠ¤íŠ¸ ë³€ê²½
        text.textContent = "CLEAR";
        nextBtn.textContent = "ë‹¤ìŒ ì±•í„°ë¡œ â–¶";
        
        // í´ë¦¬ì–´ ìŠ¤íƒ€ì¼ ì ìš© (CSS í´ë˜ìŠ¤ ì¶”ê°€)
        overlay.classList.add('clear-screen');
        
        // ì˜¤ë²„ë ˆì´ í‘œì‹œ
        overlay.style.display = 'flex';
        setTimeout(() => {
          overlay.style.opacity = 1;
          overlay.style.pointerEvents = 'auto';
          
          // í…ìŠ¤íŠ¸ ì• ë‹ˆë©”ì´ì…˜ ë¦¬ì…‹ ë° ì¬ì‹œì‘
          text.style.animation = 'none';
          text.offsetHeight; // ë¦¬í”Œë¡œìš° íŠ¸ë¦¬ê±°
          text.style.animation = 'slideIn 1.5s forwards';
        }, 10);
      }

      // ê¸ˆê³  ë˜ëŠ” í¼ì¦ í‚¤ì›Œë“œì— ëŒ€í•œ íŠ¹ìˆ˜ ì²˜ë¦¬ ì¶”ê°€
      const puzzleKeywords = ["ê¸ˆê³ ", "í¼ì¦", "ë²„íŠ¼", "ë²„íŠ¼ì„ ëˆ„ë¥´ë‹¤", "ëˆ„ë¥´ê¸°", "ë²„íŠ¼ í¼ì¦", "ë¹„ë°€ë²ˆí˜¸", "ë¹„ë°€"];
      if (puzzleKeywords.some(keyword => message.includes(keyword)) && !safeOpened) {
        displayMessage('ìŠ¤í‹°ë¸Œ', 'ê¸ˆê³ ì— ë²„íŠ¼ì´ ìˆë„¤ìš”. ë²„íŠ¼ì„ ëˆ„ë¥´ëŠ” ìˆœì„œê°€ ìˆëŠ” ê²ƒ ê°™ì€ë°...', 'steve');
        
        setTimeout(() => {
          const buttonContainer = document.createElement('div');
          buttonContainer.classList.add('choice-container');
          buttonContainer.innerHTML = `
            <button class="choice-btn" onclick="addToSequence('ë³„')">â˜… ë³„</button>
            <button class="choice-btn" onclick="addToSequence('ë„¤ëª¨')">â–  ë„¤ëª¨</button>
            <button class="choice-btn" onclick="addToSequence('ë™ê·¸ë¼ë¯¸')">â— ë™ê·¸ë¼ë¯¸</button>
            <button class="choice-btn" onclick="addToSequence('ì„¸ëª¨')">â–² ì„¸ëª¨</button>
            <button class="choice-btn" onclick="submitSequence()">ì…ë ¥ ì™„ë£Œ</button>
          `;
          document.getElementById("responseBox").appendChild(buttonContainer);
          
          // ì‹œí€€ìŠ¤ ë””ìŠ¤í”Œë ˆì´ ì¶”ê°€
          const sequenceDisplay = document.createElement('div');
          sequenceDisplay.id = 'sequenceDisplay';
          document.getElementById("responseBox").appendChild(sequenceDisplay);
          
          document.getElementById("responseBox").scrollTop = responseBox.scrollHeight;
        }, 1500);
        
        return;
      } else if (puzzleKeywords.some(keyword => message.includes(keyword)) && safeOpened) {
        displayMessage('ìŠ¤í‹°ë¸Œ', 'ê¸ˆê³  ì•ˆì— ìª½ì§€ê°€ ìˆì—ˆì–´ìš”. ìª½ì§€ë¥¼ ì½ì–´ë³¼ê¹Œìš”?!', 'steve');
        return;
      }
  
      console.log("í˜„ì¬ ì±•í„°:", currentChapter); 
      console.log("í”Œë ˆì´ì–´ ì´ë¦„:", getPlayerName());
  
      let serverURL = '';
      if (currentChapter === 1) {
        serverURL = 'http://localhost:3000/chat';
      } else if (currentChapter === 2) {
        serverURL = 'http://localhost:3002/chapter2';
      } else if (currentChapter === 3) {
        serverURL = '/index3.html';
      }
  
      try {
        const res = await fetch(serverURL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            message, 
            name: getPlayerName() // í˜„ì¬ í”Œë ˆì´ì–´ ì´ë¦„ ì „ì†¡
          })
        });
  
        const data = await res.json();
        console.log(data);
  
        if (!Array.isArray(data.message)) {
          displayMessage('ìŠ¤í‹°ë¸Œ', data.message, 'steve');
          if (data.message === "ëŒ€í™”ë¥¼ ì´ì–´ê°ˆ ìˆ˜ ì—†ë‹¤ëŠ” ê²Œ ìŠ¬í”„ë„¤ìš”.") {
            // 3ì´ˆ í›„ì— ê²Œì„ ì˜¤ë²„ í™”ë©´ í‘œì‹œ
            setTimeout(() => {
              showGameOverScreen();
            }, 3000);
          }
        } else {
          data.message.forEach((msg) => {
            const role = msg.type === 'narration' ? 'narration' : 'steve';
            displayMessage(msg.type === 'narration' ? 'SYSTEM' : 'ìŠ¤í‹°ë¸Œ', msg.text, role);
  
            // ë¬¸ ê´€ë ¨ ì¡°ê±´ë“¤
            if (msg.type === 'steve' && msg.text.includes('ë¬¸ì´ ì—´ë ¸ì–´ìš”...')) {
              setTimeout(() => showOverlayAndButton(2), 1000);
            }
            if (msg.type === 'steve' && msg.text.includes('ë¬¸ì´ ì—´ë¦° ê²ƒ ê°™ì•„ìš”')) {
              setTimeout(() => showOverlayAndButton(2), 1000);
            }
            if (msg.type === 'steve' && (msg.text.includes('ë¬¸ì´ ì—´ë¦°') || msg.text.includes('ë¬¸ì´ ì—´ë ¸ì–´ìš”'))) {
              setTimeout(() => showOverlayAndButton(2), 1000);
            }
            if (msg.type === 'steve' && msg.text.includes('ì±…ì¥ì´... ë¬¸ì´ì˜€ë„¤ìš”...! ì €ê¸° ë­ê°€ ë³´ì´ëŠ” ê²ƒ ê°™ì€ë°ìš”?')) {
              setTimeout(() => showOverlayAndButton(3), 1000);
            }
            if (msg.type === 'steve' && msg.text.includes('ì±…ì¥ì´... ë¬¸ì´ì˜€ë„¤ìš”...! ì €ê¸° ë­ê°€ ë³´ì´ëŠ” ê²ƒ ê°™ì€ë°ìš”?')) {
              setTimeout(() => showOverlayAndButton(3), 1500);
            }

            if (msg.type === 'steve' && msg.text === "ëŒ€í™”ë¥¼ ì´ì–´ê°ˆ ìˆ˜ ì—†ë‹¤ëŠ” ê²Œ ìŠ¬í”„ë„¤ìš”.") {
              // 3ì´ˆ í›„ì— ê²Œì„ ì˜¤ë²„ í™”ë©´ í‘œì‹œ
              setTimeout(() => {
                showGameOverScreen();
              }, 3000);
            }
          });
        }
  
        const sceneImage = document.getElementById("sceneImage");
        if (data.image) {
          sceneImage.src = data.image;
          updateStatusText(data.image);
        } else {
          sceneImage.src = 'Save-steve.gif';
          updateStatusText('Save-steve.gif');
        }
  
      } catch (err) {
        console.error('Error:', err);
        displayMessage('SYSTEM', 'ì„œë²„ ì—°ê²° ì‹¤íŒ¨', 'narration');
      }
  
      document.getElementById("promptInput").value = '';
    }
  
    function displayMessage(author, message, className) {
      const responseBox = document.getElementById("responseBox");
      const messageElement = document.createElement("p");
      messageElement.className = `message ${className}`;
      messageElement.innerHTML = `<strong>${author}:</strong> ${message}`;
      responseBox.appendChild(messageElement);
      responseBox.scrollTop = responseBox.scrollHeight;
    }
  
    function handleKeyPress(event) {
      if (event.key === 'Enter') {
        generateResponse();
      }
    }
  
    function showOverlayAndButton(chapterNumber) {
      nextChapterNumber = chapterNumber;
      const overlay = document.getElementById("chapter-transition-overlay");
      const text = document.getElementById("chapter-transition-text");
      const nextBtn = document.getElementById("next-chapter-btn");
  
      // ì˜¤ë²„ë ˆì´ í‘œì‹œ
      overlay.style.display = 'flex';
      setTimeout(() => {
        overlay.style.opacity = 1;
        overlay.style.pointerEvents = 'auto';
        
        // í…ìŠ¤íŠ¸ ì• ë‹ˆë©”ì´ì…˜ ë¦¬ì…‹ ë° ì¬ì‹œì‘
        text.style.animation = 'none';
        text.offsetHeight; // ë¦¬í”Œë¡œìš° íŠ¸ë¦¬ê±°
        text.style.animation = 'slideIn 1.5s forwards';
      }, 10);
    }
  
    function hideOverlayAndTransition() {
      const overlay = document.getElementById("chapter-transition-overlay");
      overlay.style.opacity = 0;
      overlay.style.pointerEvents = 'none';
      
      setTimeout(() => {
        overlay.style.display = 'none';
        const text = document.getElementById("chapter-transition-text");
        text.style.animation = 'none';
        text.style.transform = 'translateY(100%)';
        text.style.opacity = 0;
      }, 500);
    }
  
    function handleChoice(choice) {
      console.log("ì„ íƒí•œ ì„ íƒì§€:", choice);
      const responseBox = document.getElementById("responseBox");
  
      // ì„ íƒì— ë”°ë¥¸ ë°˜ì‘ ì²˜ë¦¬
      if (choice === 'ì—´ì–´ë³´ì') {
        boxOpened = true;
        displayMessage('ìŠ¤í‹°ë¸Œ', 'ìƒìë¥¼ ì—´ì–´ë´¤ì–´ìš”. ì•ˆì— ë¬´ì–¸ê°€ ìˆëŠ” ê²ƒ ê°™ì•„ìš”... ë¹µê³¼ ë¬¼ì´ ë“¤ì–´ìˆì—ˆë„¤ìš”...!', 'steve');
      } else if (choice === 'ì—´ì§€ë§ì') {
        displayMessage('ìŠ¤í‹°ë¸Œ', 'ê·¸ë˜ìš”... ê´œíˆ ë¬´ì„œìš°ë‹ˆê¹Œ ê·¸ëƒ¥ ë‘ì£ .', 'steve');
      }
  
      // ì„ íƒ í›„ ë²„íŠ¼ ì œê±°
      const choiceButtons = document.querySelector('.choice-container');
      if (choiceButtons) choiceButtons.remove();
  
      // ìƒì ìƒíƒœ ì—…ë°ì´íŠ¸ í›„ í›„ì† ì¡°ì¹˜
      if (boxOpened) {
        setTimeout(() => {
          displayMessage('ìŠ¤í‹°ë¸Œ', 'ìŒì‹ì´ ìˆë‹¤ë‹ˆ ì¢‹ë„¤ìš”! ë‹¤ë¥¸ ê±¸ ë” ì°¾ì•„ë³¼ê¹Œìš”?', 'steve');
        }, 1500);
      }
    }
  
    function showGameOverScreen() {
      const overlay = document.getElementById('game-over-overlay');
      const messageText = document.getElementById('game-over-message');
      messageText.textContent = "ìŠ¤í‹°ë¸Œë¥¼ í™”ë‚˜ê²Œ í•œ ê±´ ì•„ë‹ˆê² ì£ ?";
      overlay.style.display = "flex";
    }
  
    // ë²„íŠ¼ ì‹œí€€ìŠ¤ ê´€ë ¨ í•¨ìˆ˜ë“¤
    function addToSequence(shape) {
      if (currentSequence.length < 4) {
        currentSequence.push(shape);
        updateSequenceDisplay();
      }
    }
  
    function updateSequenceDisplay() {
      const display = document.getElementById('sequenceDisplay') || document.createElement('div');
      display.id = 'sequenceDisplay';
      display.innerHTML = currentSequence.map(shape => {
        const symbolMap = {
          'ë™ê·¸ë¼ë¯¸': 'â—', 'ì„¸ëª¨': 'â–²', 'ë³„': 'â˜…', 'ë„¤ëª¨': 'â– '
        };
        return `<span style="margin-right: 8px;">${symbolMap[shape]}</span>`;
      }).join('');
  
      document.getElementById('responseBox').appendChild(display);
    }
  
    function submitSequence() {
      // ì •ë‹µ í™•ì¸ (ì´ ë¶€ë¶„ì€ ì‹¤ì œ ì •ë‹µìœ¼ë¡œ ìˆ˜ì • í•„ìš”)
      const correctOrder = ['ë³„', 'ë„¤ëª¨', 'ë™ê·¸ë¼ë¯¸', 'ì„¸ëª¨'];
      const isCorrect = currentSequence.length === 4 && 
                      currentSequence.every((shape, index) => shape === correctOrder[index]);
      
      if (isCorrect) {
        // ì„±ê³µ ì‹œ
        safeOpened = true;
        displayMessage('ìŠ¤í‹°ë¸Œ', 'ë§ì•˜ì–´ìš”! ê¸ˆê³ ê°€ ì—´ë ¸ìŠµë‹ˆë‹¤!', 'steve');
        // ì„ íƒ ë²„íŠ¼ ì œê±°
        const choiceButtons = document.querySelector('.choice-container');
        if (choiceButtons) choiceButtons.remove();
        
        // ì‹œí€€ìŠ¤ í‘œì‹œ ì œê±°
        const sequenceDisplay = document.getElementById('sequenceDisplay');
        if (sequenceDisplay) sequenceDisplay.remove();
        
        // ê¸ˆê³  ì—´ë¦° í›„ ì¶”ê°€ ì•¡ì…˜
        setTimeout(() => {
          displayMessage('ìŠ¤í‹°ë¸Œ', 'ì•ˆì— ìª½ì§€ê°€ ìˆë„¤ìš”. ì½ì–´ë³¼ê¹Œìš”?', 'steve');
        }, 1500);
      } else {
        // ì‹¤íŒ¨ ì‹œ
        displayMessage('ìŠ¤í‹°ë¸Œ', 'ì´ ìˆœì„œëŠ” ì•„ë‹Œ ê²ƒ ê°™ë„¤ìš”. ë‹¤ì‹œ í•´ë³¼ê¹Œìš”?', 'steve');
        
        // ê¸°ì¡´ ì‹œí€€ìŠ¤ í‘œì‹œ ì œê±°
        const sequenceDisplay = document.getElementById('sequenceDisplay');
        if (sequenceDisplay) sequenceDisplay.remove();
        
        // ë²„íŠ¼ ì»¨í…Œì´ë„ˆ ì œê±° í›„ ì¬ìƒì„±
        const oldButtonContainer = document.querySelector('.choice-container');
        if (oldButtonContainer) oldButtonContainer.remove();
        
        setTimeout(() => {
          const buttonContainer = document.createElement('div');
          buttonContainer.classList.add('choice-container');
          buttonContainer.innerHTML = `
            <button class="choice-btn" onclick="addToSequence('ë™ê·¸ë¼ë¯¸')">â— ë™ê·¸ë¼ë¯¸</button>
            <button class="choice-btn" onclick="addToSequence('ë³„')">â˜… ë³„</button>
            <button class="choice-btn" onclick="addToSequence('ì„¸ëª¨')">â–² ì„¸ëª¨</button>
            <button class="choice-btn" onclick="addToSequence('ë„¤ëª¨')">â–  ë„¤ëª¨</button>
            <button class="choice-btn" onclick="submitSequence()">ì…ë ¥ ì™„ë£Œ</button>
          `;
          document.getElementById("responseBox").appendChild(buttonContainer);
          document.getElementById("responseBox").scrollTop = responseBox.scrollHeight;
        }, 1500);
      }
      
      // ì‹œí€€ìŠ¤ ì´ˆê¸°í™”
      currentSequence = [];
    }
  
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜ë“¤
    window.onload = async () => {
        // í”Œë ˆì´ì–´ ì´ë¦„ì´ ì„¤ì •ë˜ì–´ ìˆë‹¤ë©´ í‘œì‹œ
        const storedName = localStorage.getItem('playerName');
        if (storedName && storedName !== 'í”Œë ˆì´ì–´') {
            playerName = storedName;
            showTextForFiveSeconds();
        }
        
        // ì„œë²„ì—ì„œ í”Œë ˆì´ì–´ ì´ë¦„ ë™ê¸°í™” ì‹œë„ (ì„ íƒì‚¬í•­)
        try {
            const response = await fetch(`http://localhost:300${currentChapter}/sync-name`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: getPlayerName() })
            });
            const data = await response.json();
            if (data.success) {
                console.log('ì„œë²„ì™€ í”Œë ˆì´ì–´ ì´ë¦„ ë™ê¸°í™” ì™„ë£Œ');
            }
        } catch (error) {
            console.log('ì„œë²„ ë™ê¸°í™” ì‹¤íŒ¨ (ì •ìƒ ë™ì‘)', error.message);
        }
    };
  
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById("next-chapter-btn").addEventListener("click", () => {
        switchChapter(nextChapterNumber);
      });
      
      document.getElementById("retry-btn").addEventListener("click", () => {
        location.reload();
      });
    });
  
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById("next-chapter-btn").addEventListener("click", () => {
    // ğŸ”¥ Chapter 3ìœ¼ë¡œ ê°€ëŠ” ê²½ìš°
    if (nextChapterNumber === 3) {
      console.log('Chapter 3ìœ¼ë¡œ ì´ë™ ì‹œë„...'); // ë””ë²„ê¹…ìš©
      localStorage.setItem('playerName', getPlayerName());
      window.location.href = 'http://localhost:3003/chapter3';
      return;
    }
    
    // ê¸°ì¡´ ë¡œì§
    switchChapter(nextChapterNumber);
  });
  
  document.getElementById("retry-btn").addEventListener("click", () => {
    location.reload();
  });
});

    // ì „ì—­ìœ¼ë¡œ í•¨ìˆ˜ë“¤ì„ ë…¸ì¶œ (ë‹¤ë¥¸ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì‚¬ìš© ê°€ëŠ¥)
    window.gameUtils = {
        setPlayerName,
        getPlayerName,
        showTextForFiveSeconds
    };
  </script>
</body>
</html>
