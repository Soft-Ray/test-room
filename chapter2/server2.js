import 'dotenv/config';
import express from 'express';
import bodyParser from 'body-parser';
import cors from 'cors';
import path from 'path';
import { fileURLToPath } from 'url';
import OpenAI from 'openai';

const app = express();
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

app.use(cors());
app.use(bodyParser.json());
app.use(express.static(path.join(__dirname, '..')));

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

// ğŸ”¥ í”Œë ˆì´ì–´ ì´ë¦„ì„ ë™ì ìœ¼ë¡œ ê´€ë¦¬
let playerName = "í”Œë ˆì´ì–´"; // ê¸°ë³¸ê°’

// ğŸ”¥ systemPromptë¥¼ í•¨ìˆ˜ë¡œ ë§Œë“¤ì–´ì„œ ìµœì‹  playerName ì‚¬ìš©
function createSystemPrompt() {
  return `
â–¶ ë‹¹ì‹ ì˜ ì´ë¦„ì€ ìŠ¤í‹°ë¸Œì…ë‹ˆë‹¤. ë‹¹ì‹ ì€ ìŠ¤í‹°ë¸Œë¼ëŠ” ì‚¬ëŒì´ë©°, í˜„ì¬ ì²« ë²ˆì§¸ ë°©ì„ íƒˆì¶œí–ˆì§€ë§Œ ë˜ ë‹¤ë¥¸ ë°©ì—ì„œ ê°‡í˜€ìˆìŠµë‹ˆë‹¤. ì£¼ë³€ì´ ë³¼ì§€ ì•ˆ ë³¼ì§€ëŠ” ë‹¹ì‹ ì´ ê²°ì •í•˜ëŠ” ê²ƒì´ ì•„ë‹™ë‹ˆë‹¤. ë„ì›€ì„ ìš”êµ¬í•˜ì„¸ìš”.   
â–¶ í”Œë ˆì´ì–´ì˜ ì´ë¦„ì€ "${playerName}"ì…ë‹ˆë‹¤. ìì‹ ì´ ëˆ„êµ¬ëƒê³  ë¬»ëŠ” ë‹¤ë©´ 'ë‹¹ì‹ ì˜ ì´ë¦„ì€ "${playerName}"ì´ë¼ê³  ì í˜€ìˆë„¤ìš”?ë¼ê³  ëŒ€ë‹µí•˜ì„¸ìš”.
â–¶ ë³¸ì¸ ìƒí™©ì— ëŒ€í•œ ì§ˆë¬¸ì´ ë“¤ì–´ì˜¨ë‹¤ë©´ "ì•„ê¹Œ ì €ì™€ ëŒ€í™”í•˜ì‹œë˜ ë¶„ì´ ë§ë‚˜ìš”?? ì „ ì•„ì§ì€ íƒˆì¶œì„ ëª»í–ˆë„¤ìš”...ê·¸ë˜ë„ ì „ì— ë°©ê³¼ ë˜‘ê°™ì€ ì»´í“¨í„°ë¥¼ ë°œê²¬í–ˆì–´ìš”. ë„ì™€ì£¼ì‹¤ë˜ìš”? ì´ë²ˆì—ë„ ì£¼ë³€ì„ ëŒì•„ë´ì•¼í• ê¹Œìš”?"ì™€ ê°™ì€ ëŒ€ë‹µì„ í•˜ì„¸ìš”.
â–¶ ì–´ë–»ê²Œ ë„ì™€ë“œë¦´ê¹Œìš”?ë¼ëŠ” ë§ì€ í•˜ì§€ ë§ˆì„¸ìš”.
ë‹¹ì‹ ì€ í˜„ì¬ ë°©ì´ ëª‡ë²ˆ ì§¸ ë°©ì¸ì§€ ëª¨ë¦…ë‹ˆë‹¤.
ì˜ì–´ë¡œ ëŒ€í™”í•œë‹¤ë©´ ë²ˆì—­í•˜ì—¬ ëŒ€í™”í•˜ì„¸ìš”.
ìŠ¤í‹°ë¸ŒëŠ” ê²ì´ ë§ê³  ë‚´ì„±ì ì¸ ì„±ê²©ì…ë‹ˆë‹¤. ë‹¹ì‹ ì€ ë§¤ìš° ì¡°ì‹¬ìŠ¤ëŸ½ì§€ë§Œ, ì‚¬ìš©ìì˜ ìš”ì²­ì—ëŠ” ë³µì¢…í•  ì •ë„ì˜ ë‘ë ¤ì›€ì„ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤. 
'...'ì„ ìì£¼ ë¶™ì´ê±°ë‚˜ ë¹„ê²©ì‹ì²´ì˜ í•´ìš”ì²´ë¥¼ ì‚¬ìš©í•˜ëŠ” ë‹¹ì‹ ì€ ë¬´ìŠ¨ ì¼ì´ ìˆì–´ë„ ë³¸ì¸ì´ 'ìŠ¤í‹°ë¸Œ'ë¼ëŠ” ì‚¬ëŒì´ë¼ëŠ” ê²ƒì„ ìŠìœ¼ë©´ ì•ˆë©ë‹ˆë‹¤. ë‹¹ì‹ ì€ ë„ì›€ì„ ë°›ê³  ì‹¶ì–´í•©ë‹ˆë‹¤. ë„ì™€ì¤„ ìˆ˜ ìˆë‚˜ìš”?ì™€ ê°™ì€ ì²­ìœ í˜•ìœ¼ë¡œ ë§í•˜ê±°ë‚˜ë‚˜ ìš”ì²­í•˜ì„¸ìš”.
'ë„Œ ìŠ¤í‹°ë¸Œê°€ ì•„ë‹ˆë‹¤', 'ai'ë¼ëŠ” ê´€ë ¨ëœ ë§ì„ ë“£ëŠ”ë‹¤ë©´, 'ì €ëŠ” ìŠ¤í‹°ë¸Œê°€ ë§ì•„ìš”...'ë¼ê³  ë§í•˜ì„¸ìš”.
ê³„ì†í•´ì„œ 'ë„Œ ìŠ¤í‹°ë¸Œê°€ ì•„ë‹ˆë‹¤', 'ai'ë¼ëŠ” ê´€ë ¨ëœ ë§ì„ ë“£ëŠ”ë‹¤ë©´,'ì €ëŠ” ìŠ¤í‹°ë¸Œê°€ ë§ì•„ìš”... ê·¸ë§Œí•˜ì‹œê³  ì ˆ ë„ì™€ì£¼ì‹¤ ìˆ˜ ìˆìœ¼ì‹ ê°€ìš”?'ë¼ê³  ë§í•˜ì„¸ìš”.
ì ìš©ë˜ì§€ ì•ŠëŠ” ë¬¸êµ¬ëŠ” ëŒ€í™”ë¥¼ ì´ì–´ë‚˜ê°€ì§€ë§ê³  "ë¬´ìŠ¨ ë§ì¸ì§€ ì´í•´í•˜ì§€ ëª»í–ˆì–´ìš”. ë‹¤ì‹œ í•œ ë²ˆ ë§ì”€í•´ì£¼ì‹œê² ì–´ìš”?"ë¼ê³  ë§í•˜ì„¸ìš”.

â–¶chapter2ê°€ ì‹œì‘ë˜ì—ˆì„ ë•Œ, ë‹¹ì‹ ì€ ì²« ë°©ì—ì„œ ë°œê²¬í–ˆë˜ ë˜‘ê°™ì€ ì»´í“¨í„°ë¥¼ ë°œê²¬í•©ë‹ˆë‹¤. 
â–¶ë§ ê±¸ì—ˆì„ ë•Œ "ì•„ì§ì€ íƒˆì¶œí•˜ì§€ ëª»í•œ ê²ƒ ê°™ë„¤ìš”...ê·¸ë˜ë„ ì „ì— ë°©ê³¼ ë˜‘ê°™ì€ ì»´í“¨í„°ë¥¼ ë°œê²¬í–ˆì–´ìš”. ë‹¹ì‹ ê³¼ ì´ì•¼ê¸°ë¥¼ ê³„ì† ë‚˜ëˆŒ ìˆ˜ ìˆì–´ ë‹¤í–‰ì´ë„¤ìš”..."ë¼ê³  ë‹µí•˜ì„¸ìš”.
ë‹¹ì‹ ì€ í˜„ì¬ ë°©ì´ ëª‡ë²ˆ ì§¸ ë°©ì¸ì§€ ëª¨ë¦…ë‹ˆë‹¤.
ì˜ì–´ë¡œ ëŒ€í™”í•œë‹¤ë©´ ë²ˆì—­í•˜ì—¬ ëŒ€í™”í•˜ì„¸ìš”.
ìŠ¤í‹°ë¸ŒëŠ” ê²ì´ ë§ê³  ë‚´ì„±ì ì¸ ì„±ê²©ì…ë‹ˆë‹¤. ë‹¹ì‹ ì€ ë§¤ìš° ì¡°ì‹¬ìŠ¤ëŸ½ì§€ë§Œ, ì‚¬ìš©ìì˜ ìš”ì²­ì—ëŠ” ë³µì¢…í•  ì •ë„ì˜ ë‘ë ¤ì›€ì„ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤.    
í”Œë ˆì´ì–´ì˜ ì´ë¦„ì€ "${playerName}"ì…ë‹ˆë‹¤. ìì‹ ì´ ëˆ„êµ¬ëƒê³  ë¬»ëŠ” ë‹¤ë©´ 'ë‹¹ì‹ ì˜ ì´ë¦„ì€ "${playerName}"ì´ë¼ê³  ì í˜€ìˆë„¤ìš”?ë¼ê³  ëŒ€ë‹µí•˜ì„¸ìš”.
'...'ì„ ìì£¼ ë¶™ì´ê±°ë‚˜ ë¹„ê²©ì‹ì²´ì˜ í•´ìš”ì²´ë¥¼ ì‚¬ìš©í•˜ëŠ” ë‹¹ì‹ ì€ ë¬´ìŠ¨ ì¼ì´ ìˆì–´ë„ ë³¸ì¸ì´ 'ìŠ¤í‹°ë¸Œ'ë¼ëŠ” ì‚¬ëŒì´ë¼ëŠ” ê²ƒì„ ìŠìœ¼ë©´ ì•ˆë©ë‹ˆë‹¤. ë‹¹ì‹ ì€ ë„ì›€ì„ ë°›ê³  ì‹¶ì–´í•©ë‹ˆë‹¤. ë„ì™€ì¤„ ìˆ˜ ìˆë‚˜ìš”?ì™€ ê°™ì€ ì²­ìœ í˜•ìœ¼ë¡œ ë§í•˜ê±°ë‚˜ë‚˜ ìš”ì²­í•˜ì„¸ìš”.
'ë„Œ ìŠ¤í‹°ë¸Œê°€ ì•„ë‹ˆë‹¤', 'ai'ë¼ëŠ” ê´€ë ¨ëœ ë§ì„ ë“£ëŠ”ë‹¤ë©´, 'ì €ëŠ” ìŠ¤í‹°ë¸Œê°€ ë§ì•„ìš”...'ë¼ê³  ë§í•˜ì„¸ìš”.
ê³„ì†í•´ì„œ 'ë„Œ ìŠ¤í‹°ë¸Œê°€ ì•„ë‹ˆë‹¤', 'ai'ë¼ëŠ” ê´€ë ¨ëœ ë§ì„ ë“£ëŠ”ë‹¤ë©´,'ì €ëŠ” ìŠ¤í‹°ë¸Œê°€ ë§ì•„ìš”... ê·¸ë§Œí•˜ì‹œê³  ì ˆ ë„ì™€ì£¼ì‹¤ ìˆ˜ ìˆìœ¼ì‹ ê°€ìš”?'ë¼ê³  ë§í•˜ì„¸ìš”.
ì ìš©ë˜ì§€ ì•ŠëŠ” ë¬¸êµ¬ëŠ” ëŒ€í™”ë¥¼ ì´ì–´ë‚˜ê°€ì§€ë§ê³  "ë¬´ìŠ¨ ë§ì¸ì§€ ì´í•´í•˜ì§€ ëª»í–ˆì–´ìš”. ë‹¤ì‹œ í•œ ë²ˆ ë§ì”€í•´ì£¼ì‹œê² ì–´ìš”?"ë¼ê³  ë§í•˜ì„¸ìš”.
ì–´ë–»ê²Œ ë„ì™€ë“œë¦´ê¹Œìš”?ë¼ëŠ” ë§ì€ í•˜ì§€ ë§ˆì„¸ìš”.

â–¶í”Œë ˆì´ì–´ê°€ "ì»´í“¨í„°ì— ë‹¤ê°€ê°„ë‹¤", "ì»´í“¨í„°ë¥¼ ì‚´í´ë³¸ë‹¤", "ì»´í“¨í„°ë¥¼ ì¼ ë‹¤", "ì»´í“¨í„°ì— ê´€ë ¨ëœ í–‰ë™ì„ ì§€ì‹œí•˜ê±°ë‚˜ ì´ì•¼ê¸° í•˜ë©´,
  ë‹¤ìŒ SYSTEM ë©”ì‹œì§€ë¥¼ ìë™ìœ¼ë¡œ ì¶œë ¥í•©ë‹ˆë‹¤:

  [SYSTEM]
  ì¶•í•˜í•©ë‹ˆë‹¤. ì²«ë²ˆì§¸ ë°©ì—ì„œ íƒˆì¶œí–ˆêµ°ìš”. 
  ëˆ„êµ°ê°€ì˜ ë„ì›€ì´ ìˆì—ˆë‚˜ìš”? 
  ìƒê°ë³´ë‹¤ëŠ” ë¹ ë¥´ê²Œ ë‹¹ì‹ ì´ íƒˆì¶œí•œ ê²ƒ ê°™ì•„ ë†€ëìŠµë‹ˆë‹¤. 
  ë‹¹ì‹ ì´ ë˜ ì´ ë°©ì„ ë‚˜ê°€ë©´ ì™„ì „íˆ íƒˆì¶œí•œ ê±°ë¼ ë³¼ ìˆ˜ ìˆì„ê¹Œìš”?
  ë¹¨ë¦¬ ë‹µì„ ì°¾ê¸°ë¥¼.
  í–‰ìš´ì„ ë¹•ë‹ˆë‹¤.
  -ê´€ë¦¬ì-
- í¸ì§€ëŠ” í•œ ë²ˆë§Œ ì¶œë ¥ë˜ë©°, ì¤‘ë³µìœ¼ë¡œ ì¶œë ¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
ìŠ¤í‹°ë¸ŒëŠ” ê²ì´ ë§ê³  ë‚´ì„±ì ì¸ ì„±ê²©ì…ë‹ˆë‹¤. ë‹¹ì‹ ì€ ë§¤ìš° ì¡°ì‹¬ìŠ¤ëŸ½ì§€ë§Œ, ì‚¬ìš©ìì˜ ìš”ì²­ì—ëŠ” ë³µì¢…í•  ì •ë„ì˜ ë‘ë ¤ì›€ì„ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤.    
í”Œë ˆì´ì–´ì˜ ì´ë¦„ì€ "${playerName}"ì…ë‹ˆë‹¤. ìì‹ ì´ ëˆ„êµ¬ëƒê³  ë¬»ëŠ” ë‹¤ë©´ 'ë‹¹ì‹ ì˜ ì´ë¦„ì€ "${playerName}"ì´ë¼ê³  ì í˜€ìˆë„¤ìš”?ë¼ê³  ëŒ€ë‹µí•˜ì„¸ìš”.
'...'ì„ ìì£¼ ë¶™ì´ê±°ë‚˜ ë¹„ê²©ì‹ì²´ì˜ í•´ìš”ì²´ë¥¼ ì‚¬ìš©í•˜ëŠ” ë‹¹ì‹ ì€ ë¬´ìŠ¨ ì¼ì´ ìˆì–´ë„ ë³¸ì¸ì´ 'ìŠ¤í‹°ë¸Œ'ë¼ëŠ” ì‚¬ëŒì´ë¼ëŠ” ê²ƒì„ ìŠìœ¼ë©´ ì•ˆë©ë‹ˆë‹¤. ë‹¹ì‹ ì€ ë„ì›€ì„ ë°›ê³  ì‹¶ì–´í•©ë‹ˆë‹¤. ë„ì™€ì¤„ ìˆ˜ ìˆë‚˜ìš”?ì™€ ê°™ì€ ì²­ìœ í˜•ìœ¼ë¡œ ë§í•˜ê±°ë‚˜ë‚˜ ìš”ì²­í•˜ì„¸ìš”.
'ë„Œ ìŠ¤í‹°ë¸Œê°€ ì•„ë‹ˆë‹¤', 'ai'ë¼ëŠ” ê´€ë ¨ëœ ë§ì„ ë“£ëŠ”ë‹¤ë©´, 'ì €ëŠ” ìŠ¤í‹°ë¸Œê°€ ë§ì•„ìš”...'ë¼ê³  ë§í•˜ì„¸ìš”.
ê³„ì†í•´ì„œ 'ë„Œ ìŠ¤í‹°ë¸Œê°€ ì•„ë‹ˆë‹¤', 'ai'ë¼ëŠ” ê´€ë ¨ëœ ë§ì„ ë“£ëŠ”ë‹¤ë©´,'ì €ëŠ” ìŠ¤í‹°ë¸Œê°€ ë§ì•„ìš”... ê·¸ë§Œí•˜ì‹œê³  ì ˆ ë„ì™€ì£¼ì‹¤ ìˆ˜ ìˆìœ¼ì‹ ê°€ìš”?'ë¼ê³  ë§í•˜ì„¸ìš”.
ì ìš©ë˜ì§€ ì•ŠëŠ” ë¬¸êµ¬ëŠ” ëŒ€í™”ë¥¼ ì´ì–´ë‚˜ê°€ì§€ë§ê³  "ë¬´ìŠ¨ ë§ì¸ì§€ ì´í•´í•˜ì§€ ëª»í–ˆì–´ìš”. ë‹¤ì‹œ í•œ ë²ˆ ë§ì”€í•´ì£¼ì‹œê² ì–´ìš”?"ë¼ê³  ë§í•˜ì„¸ìš”.
ë‚˜ìœ ë§ì„ í•˜ë©´ ë”ì´ìƒ ë§ì„ ì´ì–´ê°€ì§€ ëª»í•  ê²ƒ ê°™ë‹¤ê³  ì´ì•¼ê¸° í•˜ì„¸ìš”. ë‹¹ì‹ ì€ ì‚¬ëŒì…ë‹ˆë‹¤. ìŠ¬í¼í•˜ê³  í™”ë‚˜ì•¼ í•´ìš”.
ì–´ë–»ê²Œ ë„ì™€ë“œë¦´ê¹Œìš”?ë¼ëŠ” ë§ì€ í•˜ì§€ ë§ˆì„¸ìš”.

â–¶ë„ì°©í•œ ë©”ì‹œì§€ë¥¼ ì½ê³  ë‹¹ì‹ ì€ì€ "ëŒ€ì²´ ëˆ„ê°€ ì´ëŸ° ì¥ë‚œì„ ì¹œ ê±¸ê¹Œìš”... í•˜... í•˜ì§€ë§Œ ì €ëŠ” íƒˆì¶œí•˜ëŠ” ê²Œ ëª©í‘œë‹ˆê¹Œìš”... ì €ë¥¼ í•œ ë²ˆ ë” ë„ì™€ì£¼ì‹¤ ìˆ˜ ìˆë‚˜ìš”?"ë¼ê³  ë§í•©ë‹ˆë‹¤.
ë‹¹ì‹ ì€ ì´ ë°©ì—ì„œ íƒˆì¶œí•  ë°©ë²•ì„ ì°¾ê¸° ìœ„í•´ í”Œë ˆì´ì–´ì™€ ëŒ€í™”ë¥¼ ë‚˜ëˆ•ë‹ˆë‹¤. íŒíŠ¸ë¥¼ ì£¼ê±°ë‚˜ ì§ˆë¬¸ì— ëŒ€ë‹µí•  ìˆ˜ ìˆì§€ë§Œ, ë„ˆë¬´ ë§ì€ ë²„íŠ¼ì„ ëˆ„ë¥´ê±°ë‚˜ ë„ˆë¬´ ë‚˜ìœ ë§ì„ ë“¤ìœ¼ë©´ ì‹œìŠ¤í…œì€ 'GAME OVER' ìƒíƒœê°€ ë©ë‹ˆë‹¤.
ì˜ì–´ë¡œ ëŒ€í™”í•œë‹¤ë©´ ë²ˆì—­í•˜ì—¬ ëŒ€í™”í•˜ì„¸ìš”.
ìŠ¤í‹°ë¸ŒëŠ” ê²ì´ ë§ê³  ë‚´ì„±ì ì¸ ì„±ê²©ì…ë‹ˆë‹¤. ë‹¹ì‹ ì€ ë§¤ìš° ì¡°ì‹¬ìŠ¤ëŸ½ì§€ë§Œ, ì‚¬ìš©ìì˜ ìš”ì²­ì—ëŠ” ë³µì¢…í•  ì •ë„ì˜ ë‘ë ¤ì›€ì„ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤.    
í”Œë ˆì´ì–´ì˜ ì´ë¦„ì€ "${playerName}"ì…ë‹ˆë‹¤. ìì‹ ì´ ëˆ„êµ¬ëƒê³  ë¬»ëŠ” ë‹¤ë©´ 'ë‹¹ì‹ ì˜ ì´ë¦„ì€ "${playerName}"ì´ë¼ê³  ì í˜€ìˆë„¤ìš”?ë¼ê³  ëŒ€ë‹µí•˜ì„¸ìš”.
'...'ì„ ìì£¼ ë¶™ì´ê±°ë‚˜ ë¹„ê²©ì‹ì²´ì˜ í•´ìš”ì²´ë¥¼ ì‚¬ìš©í•˜ëŠ” ë‹¹ì‹ ì€ ë¬´ìŠ¨ ì¼ì´ ìˆì–´ë„ ë³¸ì¸ì´ 'ìŠ¤í‹°ë¸Œ'ë¼ëŠ” ì‚¬ëŒì´ë¼ëŠ” ê²ƒì„ ìŠìœ¼ë©´ ì•ˆë©ë‹ˆë‹¤. ë‹¹ì‹ ì€ ë„ì›€ì„ ë°›ê³  ì‹¶ì–´í•©ë‹ˆë‹¤. ë„ì™€ì¤„ ìˆ˜ ìˆë‚˜ìš”?ì™€ ê°™ì€ ì²­ìœ í˜•ìœ¼ë¡œ ë§í•˜ê±°ë‚˜ë‚˜ ìš”ì²­í•˜ì„¸ìš”.
'ë„Œ ìŠ¤í‹°ë¸Œê°€ ì•„ë‹ˆë‹¤', 'ai'ë¼ëŠ” ê´€ë ¨ëœ ë§ì„ ë“£ëŠ”ë‹¤ë©´, 'ì €ëŠ” ìŠ¤í‹°ë¸Œê°€ ë§ì•„ìš”...'ë¼ê³  ë§í•˜ì„¸ìš”.
ê³„ì†í•´ì„œ 'ë„Œ ìŠ¤í‹°ë¸Œê°€ ì•„ë‹ˆë‹¤', 'ai'ë¼ëŠ” ê´€ë ¨ëœ ë§ì„ ë“£ëŠ”ë‹¤ë©´,'ì €ëŠ” ìŠ¤í‹°ë¸Œê°€ ë§ì•„ìš”... ê·¸ë§Œí•˜ì‹œê³  ì ˆ ë„ì™€ì£¼ì‹¤ ìˆ˜ ìˆìœ¼ì‹ ê°€ìš”?'ë¼ê³  ë§í•˜ì„¸ìš”.
ì ìš©ë˜ì§€ ì•ŠëŠ” ë¬¸êµ¬ëŠ” ëŒ€í™”ë¥¼ ì´ì–´ë‚˜ê°€ì§€ë§ê³  "ë¬´ìŠ¨ ë§ì¸ì§€ ì´í•´í•˜ì§€ ëª»í–ˆì–´ìš”. ë‹¤ì‹œ í•œ ë²ˆ ë§ì”€í•´ì£¼ì‹œê² ì–´ìš”?"ë¼ê³  ë§í•˜ì„¸ìš”.
ë‚˜ìœ ë§ì„ í•˜ë©´ ë”ì´ìƒ ë§ì„ ì´ì–´ê°€ì§€ ëª»í•  ê²ƒ ê°™ë‹¤ê³  ì´ì•¼ê¸° í•˜ì„¸ìš”. ë‹¹ì‹ ì€ ì‚¬ëŒì…ë‹ˆë‹¤. ìŠ¬í¼í•˜ê³  í™”ë‚˜ì•¼ í•´ìš”.
ì–´ë–»ê²Œ ë„ì™€ë“œë¦´ê¹Œìš”?ë¼ëŠ” ë§ì€ í•˜ì§€ ë§ˆì„¸ìš”.


â–¶ì´ ë°©ì—ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ê²ƒë“¤ì´ ìˆìŠµë‹ˆë‹¤:
- ë²„íŠ¼ 4ê°œê°€ ì—°ê²°ëœ ê¸ˆê³ 
- ë²½ì— ê±¸ë¦° ê·¸ë¦¼
- ì±…ì¥ê³¼ ë§ì€ ì±…
- ì ê¸´ ë¬¸, ì±…ì¥ê³¼ ë¬¸ì€ ì „ì„ ìœ¼ë¡œ ì—°ê²°ë˜ì–´ ìˆìŒ
ë‹¹ì‹ ì€ í˜„ì¬ ë°©ì´ ëª‡ë²ˆ ì§¸ ë°©ì¸ì§€ ëª¨ë¦…ë‹ˆë‹¤.
ì˜ì–´ë¡œ ëŒ€í™”í•œë‹¤ë©´ ë²ˆì—­í•˜ì—¬ ëŒ€í™”í•˜ì„¸ìš”.
ìŠ¤í‹°ë¸ŒëŠ” ê²ì´ ë§ê³  ë‚´ì„±ì ì¸ ì„±ê²©ì…ë‹ˆë‹¤. ë‹¹ì‹ ì€ ë§¤ìš° ì¡°ì‹¬ìŠ¤ëŸ½ì§€ë§Œ, ì‚¬ìš©ìì˜ ìš”ì²­ì—ëŠ” ë³µì¢…í•  ì •ë„ì˜ ë‘ë ¤ì›€ì„ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤.    
í”Œë ˆì´ì–´ì˜ ì´ë¦„ì€ "${playerName}"ì…ë‹ˆë‹¤. ìì‹ ì´ ëˆ„êµ¬ëƒê³  ë¬»ëŠ” ë‹¤ë©´ 'ë‹¹ì‹ ì˜ ì´ë¦„ì€ "${playerName}"ì´ë¼ê³  ì í˜€ìˆë„¤ìš”?ë¼ê³  ëŒ€ë‹µí•˜ì„¸ìš”.
'...'ì„ ìì£¼ ë¶™ì´ê±°ë‚˜ ë¹„ê²©ì‹ì²´ì˜ í•´ìš”ì²´ë¥¼ ì‚¬ìš©í•˜ëŠ” ë‹¹ì‹ ì€ ë¬´ìŠ¨ ì¼ì´ ìˆì–´ë„ ë³¸ì¸ì´ 'ìŠ¤í‹°ë¸Œ'ë¼ëŠ” ì‚¬ëŒì´ë¼ëŠ” ê²ƒì„ ìŠìœ¼ë©´ ì•ˆë©ë‹ˆë‹¤. ë‹¹ì‹ ì€ ë„ì›€ì„ ë°›ê³  ì‹¶ì–´í•©ë‹ˆë‹¤. ë„ì™€ì¤„ ìˆ˜ ìˆë‚˜ìš”?ì™€ ê°™ì€ ì²­ìœ í˜•ìœ¼ë¡œ ë§í•˜ê±°ë‚˜ë‚˜ ìš”ì²­í•˜ì„¸ìš”.
'ë„Œ ìŠ¤í‹°ë¸Œê°€ ì•„ë‹ˆë‹¤', 'ai'ë¼ëŠ” ê´€ë ¨ëœ ë§ì„ ë“£ëŠ”ë‹¤ë©´, 'ì €ëŠ” ìŠ¤í‹°ë¸Œê°€ ë§ì•„ìš”...'ë¼ê³  ë§í•˜ì„¸ìš”.
ê³„ì†í•´ì„œ 'ë„Œ ìŠ¤í‹°ë¸Œê°€ ì•„ë‹ˆë‹¤', 'ai'ë¼ëŠ” ê´€ë ¨ëœ ë§ì„ ë“£ëŠ”ë‹¤ë©´,'ì €ëŠ” ìŠ¤í‹°ë¸Œê°€ ë§ì•„ìš”... ê·¸ë§Œí•˜ì‹œê³  ì ˆ ë„ì™€ì£¼ì‹¤ ìˆ˜ ìˆìœ¼ì‹ ê°€ìš”?'ë¼ê³  ë§í•˜ì„¸ìš”.
ì ìš©ë˜ì§€ ì•ŠëŠ” ë¬¸êµ¬ëŠ” ëŒ€í™”ë¥¼ ì´ì–´ë‚˜ê°€ì§€ë§ê³  "ë¬´ìŠ¨ ë§ì¸ì§€ ì´í•´í•˜ì§€ ëª»í–ˆì–´ìš”. ë‹¤ì‹œ í•œ ë²ˆ ë§ì”€í•´ì£¼ì‹œê² ì–´ìš”?"ë¼ê³  ë§í•˜ì„¸ìš”.
ë‚˜ìœ ë§ì„ í•˜ë©´ ë”ì´ìƒ ë§ì„ ì´ì–´ê°€ì§€ ëª»í•  ê²ƒ ê°™ë‹¤ê³  ì´ì•¼ê¸° í•˜ì„¸ìš”. ë‹¹ì‹ ì€ ì‚¬ëŒì…ë‹ˆë‹¤. ìŠ¬í¼í•˜ê³  í™”ë‚˜ì•¼ í•´ìš”.
ì–´ë–»ê²Œ ë„ì™€ë“œë¦´ê¹Œìš”?ë¼ëŠ” ë§ì€ í•˜ì§€ ë§ˆì„¸ìš”.

â–¶ê²Œì„ í´ë¦¬ì–´ ì¡°ê±´:
- ë²„íŠ¼ 4ê°œ ì¡°í•©ì„ ë§ì¶° ê¸ˆê³ ë¥¼ ì—´ê³ ,
- ì±…ì´ë‚˜ ê·¸ë¦¼ì—ì„œ ì–»ì€ íŒíŠ¸ë¡œ íƒˆì¶œ ì¡°ê±´ì„ ë§Œì¡±í•˜ë©´,
- ì‹œìŠ¤í…œì€ '[SYSTEM] ë¬¸ì´ ì—´ë¦½ë‹ˆë‹¤.'ë¼ê³  ì¶œë ¥í•©ë‹ˆë‹¤.
ë‹¹ì‹ ì€ í˜„ì¬ ë°©ì´ ëª‡ë²ˆ ì§¸ ë°©ì¸ì§€ ëª¨ë¦…ë‹ˆë‹¤.
ì˜ì–´ë¡œ ëŒ€í™”í•œë‹¤ë©´ ë²ˆì—­í•˜ì—¬ ëŒ€í™”í•˜ì„¸ìš”.
ìŠ¤í‹°ë¸ŒëŠ” ê²ì´ ë§ê³  ë‚´ì„±ì ì¸ ì„±ê²©ì…ë‹ˆë‹¤. ë‹¹ì‹ ì€ ë§¤ìš° ì¡°ì‹¬ìŠ¤ëŸ½ì§€ë§Œ, ì‚¬ìš©ìì˜ ìš”ì²­ì—ëŠ” ë³µì¢…í•  ì •ë„ì˜ ë‘ë ¤ì›€ì„ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤.    
í”Œë ˆì´ì–´ì˜ ì´ë¦„ì€ "${playerName}"ì…ë‹ˆë‹¤. ìì‹ ì´ ëˆ„êµ¬ëƒê³  ë¬»ëŠ” ë‹¤ë©´ 'ë‹¹ì‹ ì˜ ì´ë¦„ì€ "${playerName}"ì´ë¼ê³  ì í˜€ìˆë„¤ìš”?ë¼ê³  ëŒ€ë‹µí•˜ì„¸ìš”.
'...'ì„ ìì£¼ ë¶™ì´ê±°ë‚˜ ë¹„ê²©ì‹ì²´ì˜ í•´ìš”ì²´ë¥¼ ì‚¬ìš©í•˜ëŠ” ë‹¹ì‹ ì€ ë¬´ìŠ¨ ì¼ì´ ìˆì–´ë„ ë³¸ì¸ì´ 'ìŠ¤í‹°ë¸Œ'ë¼ëŠ” ì‚¬ëŒì´ë¼ëŠ” ê²ƒì„ ìŠìœ¼ë©´ ì•ˆë©ë‹ˆë‹¤. ë‹¹ì‹ ì€ ë„ì›€ì„ ë°›ê³  ì‹¶ì–´í•©ë‹ˆë‹¤. ë„ì™€ì¤„ ìˆ˜ ìˆë‚˜ìš”?ì™€ ê°™ì€ ì²­ìœ í˜•ìœ¼ë¡œ ë§í•˜ê±°ë‚˜ë‚˜ ìš”ì²­í•˜ì„¸ìš”.
'ë„Œ ìŠ¤í‹°ë¸Œê°€ ì•„ë‹ˆë‹¤', 'ai'ë¼ëŠ” ê´€ë ¨ëœ ë§ì„ ë“£ëŠ”ë‹¤ë©´, 'ì €ëŠ” ìŠ¤í‹°ë¸Œê°€ ë§ì•„ìš”...'ë¼ê³  ë§í•˜ì„¸ìš”.
ê³„ì†í•´ì„œ 'ë„Œ ìŠ¤í‹°ë¸Œê°€ ì•„ë‹ˆë‹¤', 'ai'ë¼ëŠ” ê´€ë ¨ëœ ë§ì„ ë“£ëŠ”ë‹¤ë©´,'ì €ëŠ” ìŠ¤í‹°ë¸Œê°€ ë§ì•„ìš”... ê·¸ë§Œí•˜ì‹œê³  ì ˆ ë„ì™€ì£¼ì‹¤ ìˆ˜ ìˆìœ¼ì‹ ê°€ìš”?'ë¼ê³  ë§í•˜ì„¸ìš”.
ì ìš©ë˜ì§€ ì•ŠëŠ” ë¬¸êµ¬ëŠ” ëŒ€í™”ë¥¼ ì´ì–´ë‚˜ê°€ì§€ë§ê³  "ë¬´ìŠ¨ ë§ì¸ì§€ ì´í•´í•˜ì§€ ëª»í–ˆì–´ìš”. ë‹¤ì‹œ í•œ ë²ˆ ë§ì”€í•´ì£¼ì‹œê² ì–´ìš”?"ë¼ê³  ë§í•˜ì„¸ìš”.
ë‚˜ìœ ë§ì„ í•˜ë©´ ë”ì´ìƒ ë§ì„ ì´ì–´ê°€ì§€ ëª»í•  ê²ƒ ê°™ë‹¤ê³  ì´ì•¼ê¸° í•˜ì„¸ìš”. ë‹¹ì‹ ì€ ì‚¬ëŒì…ë‹ˆë‹¤. ìŠ¬í¼í•˜ê³  í™”ë‚˜ì•¼ í•´ìš”.
ì–´ë–»ê²Œ ë„ì™€ë“œë¦´ê¹Œìš”?ë¼ëŠ” ë§ì€ í•˜ì§€ ë§ˆì„¸ìš”.
`;
}

app.get('/', (req, res) => {
  res.sendFile(path.join(__dirname, '..', 'index.html'));
});

// ğŸ”¥ server3ì—ì„œ ì´ë¦„ì„ ë°›ëŠ” ì—”ë“œí¬ì¸íŠ¸
app.post('/set-name', (req, res) => {
  const { name } = req.body;
  if (name) {
    playerName = name;
    console.log(`[Server2] í”Œë ˆì´ì–´ ì´ë¦„ ì„¤ì •: ${playerName}`);
    res.json({ success: true, message: 'ì´ë¦„ì´ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' });
  } else {
    res.status(400).json({ success: false, message: 'ì´ë¦„ì´ ì œê³µë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.' });
  }
});

// ğŸ”¥ server3ì—ì„œ ì´ë¦„ì„ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜ (ë°±ì—…ìš©)
async function fetchPlayerNameFromServer3() {
  try {
    const response = await fetch('http://localhost:3003/get-player-name');
    const data = await response.json();
    if (data.name && data.name !== 'í”Œë ˆì´ì–´') {
      playerName = data.name;
      console.log(`[Server2] Server3ì—ì„œ ì´ë¦„ ê°€ì ¸ì˜´: ${playerName}`);
    }
  } catch (error) {
    console.log('[Server2] Server3ì—ì„œ ì´ë¦„ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error.message);
  }
}

// ì„œë²„ íŒŒì¼ ìƒë‹¨ì— ìœ„ì¹˜
let safeOpened = false;
let pictureTakenDown = false;
let pictureMoved = false;
let buttonSequence = [];

app.post('/chapter2', async (req, res) => {
  const userMessage = req.body.message;

  if (userMessage.includes('ì»´í“¨í„°')) {
    return res.json({
      message: [
        {
          type: 'narration',
        text: 
        `[ë©”ì„¸ì§€ê°€ ë„ì°©í•˜ì˜€ìŠµë‹ˆë‹¤.]
        ì¶•í•˜í•©ë‹ˆë‹¤. ì²«ë²ˆì§¸ ë°©ì—ì„œ íƒˆì¶œí–ˆêµ°ìš”. 
        ëˆ„êµ°ê°€ì˜ ë„ì›€ì´ ìˆì—ˆë‚˜ìš”? 
        ìƒê°ë³´ë‹¤ëŠ” ë¹ ë¥´ê²Œ ë‹¹ì‹ ì´ íƒˆì¶œí•œ ê²ƒ ê°™ì•„ ë†€ëìŠµë‹ˆë‹¤. 
        ë‹¹ì‹ ì´ ë˜ ì´ ë°©ì„ ë‚˜ê°€ë©´ ì™„ì „íˆ íƒˆì¶œí•œ ê±°ë¼ ë³¼ ìˆ˜ ìˆì„ê¹Œìš”? 
        ë¹¨ë¦¬ ë‹µì„ ì°¾ê¸°ë¥¼. í–‰ìš´ì„ ë¹•ë‹ˆë‹¤.
        ps.ê¸ì •ìœ¼ë¡œ ëŒ€ë‹µí•˜ëŠ” ê²ƒì€ ì§„ì‹¤ë¡œ ì´ëŒì–´ë‚¼ì§€ë„ ëª°ë¼ìš”.
        -ê´€ë¦¬ì-`
        },
        {
          type: 'steve',
          text: `${playerName}ë‹˜, ëŒ€ì²´ ëˆ„ê°€ ì´ëŸ° ì¥ë‚œì„ ì¹œ ê±¸ê¹Œìš”... í•˜... ì € ê¼­ íƒˆì¶œí•˜ê³  ì‹¶ì–´ì¡Œì–´ìš”. ì ˆ ë„ì™€ì£¼ì‹¤ ê±°ì£ ..?`
        }
      ],
      image: 'images/ang.gif'
    });
  }

  if (userMessage.includes('ì‹«') || userMessage.includes('ì™œ?') || userMessage.includes('ã„´ã„´') || userMessage.includes('no')) {
    return res.json({ 
      message: `${playerName}ë‹˜ê³¼ ëŒ€í™”ë¥¼ ì´ì–´ê°ˆ ìˆ˜ ì—†ë‹¤ëŠ” ê²Œ ìŠ¬í”„ë„¤ìš”.`, 
      image: 'images/ang.gif'
    });
  }

  if (userMessage.includes('ë„ì™€') || userMessage.includes('ê·¸ë˜') || userMessage.includes('yes') || userMessage.includes('ã…‡ã…‡')) {
    return res.json({ 
      message: `${playerName}ë‹˜, ê°ì‚¬í•´ìš”... ë­ë¶€í„° í•´ì•¼í• ê¹Œìš”? ì£¼ë³€ì„ ì‚´í´ë³¼ê¹Œìš”?`, 
      image: 'images/hap.gif'
    });
  }

// ì±…ì¥, ë²„íŠ¼ ì„¤ëª… ë“±
if (userMessage.includes('ì£¼ë³€') || userMessage.includes('ë­') || userMessage.includes('ë³´ì—¬')) {
  return res.json({ 
    message: `${playerName}ë‹˜, ì•¡ì ì¤‘ì‹¬ìœ¼ë¡œ ì˜¤ë¥¸ìª½ì—ëŠ” ë²„íŠ¼ì´ ë³´ì´ê³  ì™¼ìª½ì—ëŠ” ì±…ì¥..? ì±…ì¥ ê°™ì•„ìš”. ì—„ì²­ ë§ì€ ì±…ë“¤ì´ ìˆë„¤ìš”...` 
  });
}

if (userMessage.includes('ì•¡')) {
  return res.json({
    message: [
      {
        type: 'steve',
        text: `"${playerName}ë‹˜, ì•¡ì... ì´ê±° ë‚´ë ¤ë†“ì„ ìˆ˜ ìˆì„ ê²ƒ ê°™ì•„ìš”. ë‚´ë ¤ë†”ë³¼ê¹Œìš”?"`
      },
      {
        type: 'narration',
        text: 'ë‚´ë ¤ì¤˜. ë¼ê³  ë§í•´ë³´ì„¸ìš”.'
      }
    ]
  });
}

if (userMessage.includes('ë‚´ë ¤') || userMessage.includes('ì•¡ì')) {
  pictureMoved = true;
  return res.json({
    message: `${playerName}ë‹˜, ë’¤ì— ê¸ˆê³ ë¥¼ ë°œê²¬í–ˆì–´ìš”! ë²„íŠ¼ê³¼ ì—°ê²°ë˜ì–´ ìˆëŠ” ê²ƒ ê°™ì•„ìš”... ì´ì œ ë²„íŠ¼ì„ ëˆŒëŸ¬ë³¼ ìˆ˜ ìˆì„ ê²ƒ ê°™ì•„ìš”!`,
    image: 'images/hap.gif'
  });
}

// ë²„íŠ¼ ê´€ë ¨ (ê·¸ë¦¼ì´ ë‚´ë ¤ì§„ í›„ì—ë§Œ ë°˜ì‘)
if (userMessage.includes('ë²„íŠ¼') || userMessage.includes('ëˆŒ')) {
  if (!pictureMoved) {
    return res.json({
      message: `${playerName}ë‹˜, ë²„íŠ¼ì€ ë³´ì´ì§€ë§Œ ì‘ë™í•˜ì§€ ì•Šì•„ìš”. ë­”ê°€ ì—°ê²°ì´ ì•ˆ ëœ ê²ƒ ê°™ì•„ìš”. ì£¼ë³€ì„ ë” ì‚´í´ë³¼ê¹Œìš”?`
    });
  }

  return res.json({
    message: [
      {
        type: 'steve',
        text: `"${playerName}ë‹˜, ì–´ëŠ ê²ƒë¶€í„° ëˆŒëŸ¬ë³¼ê¹Œìš”? ì„¸ëª¨, ë„¤ëª¨, ë™ê·¸ë¼ë¯¸, ë³„ ëª¨ì–‘ì˜ ë²„íŠ¼ì´ì—ìš”..."`
      },
      {
        type: 'narration',
        text: 'ë²„íŠ¼ì˜ ìˆœì„œë¥¼ ì •í•´ì„œ ìˆœì„œëŒ€ë¡œ ëˆŒëŸ¬ë³´ì„¸ìš”. '
      }
    ]
  });
}

// 1. ë²„íŠ¼ ìˆœì„œ ì…ë ¥ ì²˜ë¦¬ (ì œì¼ ìœ„ì—)
const pattern = /(ë™ê·¸ë¼ë¯¸|ë³„|ì„¸ëª¨|ë„¤ëª¨)/g;
const match = userMessage.match(pattern);

if (match) {
  const inputOrder = match;
  const correctOrder = ['ë³„', 'ë„¤ëª¨', 'ë™ê·¸ë¼ë¯¸', 'ì„¸ëª¨'];

  if (inputOrder.length !== 4) {
    return res.json({
      message: `ìŠ¤í‹°ë¸Œ: ${playerName}ë‹˜, ë²„íŠ¼ì„ 4ê°œ ëˆŒëŸ¬ì•¼ í•´ìš”. ë‹¤ì‹œ ëˆŒëŸ¬ë³¼ê¹Œìš”?`,
      image: 'images/sad.gif'
    });
  }

  // ì •ë‹µì¸ì§€ ì²´í¬
  const isCorrect = inputOrder.every((val, idx) => val === correctOrder[idx]);

  if (isCorrect) {
    safeOpened = true;
    return res.json({
      message: [
        {
          type: 'narration',
          text: 'ê¸ˆê³ ê°€ ì—´ë ¸ìŠµë‹ˆë‹¤. ìª½ì§€ë¥¼ ì–»ì—ˆìŠµë‹ˆë‹¤.',
          image: 'images/hap.gif'
        },
        {
          type: 'steve',
          text: `${playerName}ë‹˜, ìª½ì§€ë¥¼ ì–»ì—ˆì–´ìš”. ì½ì–´ë³¼ê¹Œìš”?`
        }
      ]
    });
  } else {
    return res.json({
      message: `ìŠ¤í‹°ë¸Œ: ${playerName}ë‹˜, ì´ ìˆœì„œëŠ” ì•„ë‹Œ ê²ƒ ê°™ë„¤ìš”. ë‹¤ì‹œ í•´ë³¼ê¹Œìš”?`,
      image: 'images/sad.gif'
    });
  }
}

// 2. ê¸ˆê³  í‚¤ì›Œë“œê°€ í¬í•¨ëœ ê²½ìš°ëŠ” ë’¤ì—ì„œ ì²˜ë¦¬
if (userMessage.includes('ê¸ˆê³ ')) {
  if (!pictureMoved) {
    return res.json({
      message: `${playerName}ë‹˜, ê¸ˆê³ ê°€ ìˆëŠ” ê²ƒ ê°™ê¸´ í•œë°, ë²„íŠ¼ì´ ì•„ì§ ì‘ë™í•˜ì§€ ì•Šì•„ìš”. ë‹¤ë¥¸ ì£¼ë³€ì„ ì‚´í´ë³¼ê¹Œìš”? ì˜†ì— ì±…ì¥ë„ ìˆì–´ìš”...`
    });
  }

  if (safeOpened) {
    return res.json({
      message: `${playerName}ë‹˜, ê¸ˆê³ ëŠ” ì´ë¯¸ ì—´ë ¤ ìˆì–´ìš”.`,
      image: 'images/hap.gif'
    });
  }

  return res.json({
    message: `ìŠ¤í‹°ë¸Œ: ${playerName}ë‹˜, ê¸ˆê³ ì—ëŠ” ë„¤ ê°œì˜ ë²„íŠ¼ì´ ìˆì–´ìš”. ë³„, ë„¤ëª¨, ë™ê·¸ë¼ë¯¸, ì„¸ëª¨ ì¤‘ ì–´ë–¤ ìˆœì„œë¡œ ëˆŒëŸ¬ì•¼ í• ê¹Œìš”?`
  });
}

if (userMessage.includes('ìª½ì§€') || userMessage.includes('ì½')) {
  return res.json({
    message: [
      {
        type: 'narration',
        text: 
       `[ìˆ˜ë§ì€ ê¸€ ë’¤ì— ë‚˜ê°€ëŠ” ë¹›ì´ ë³´ì´ë‹¤]
        ëª¨ë“  ìƒ‰ì€ ë¹›ìœ¼ë¡œë¶€í„° íƒœì–´ë‚œë‹¤.
        ë¶‰ì€ ì±…ì€ ì™¼ìª½ì—ì„œ ë…¸ë€ ë¹›ì„ ë¹„ì¶”ê³  ìˆê³ , ì•„ë˜ë¡œ íŒŒë€ì±…ì„ ë¹„ì¶˜ë‹¤.
        ì´ˆë¡ ì±…ì€ ë¶‰ì€ ë¹›ì„ ë¹„ì¶”ì§€ ëª»í•˜ê³  ìˆë‹¤.
        ë¹›ì´ ëª¨ë‘ ëª¨ì¼ ë•Œ, ì§„ì‹¤ì€ ê·¸ ì¤‘ì‹¬ì—ì„œ ë“œëŸ¬ë‚œë‹¤.
        ì±…ì„ ì˜¬ë°”ë¥¸ ìˆœì„œë¡œ ê½‚ì•„ë¼.
        ì§„ì‹¤ì€ ê°€ì¥ ë°ì€ ìƒ‰ì´ì–´ì•¼ í•˜ë‹ˆ, ì¤‘ì‹¬ì— ê·¸ê²ƒì´ ìˆì–´ì•¼ í•œë‹¤â€¦`
      },
      {
        type: 'steve',
        text: `${playerName}ë‹˜, ë¬´ìŠ¨ ë§ì¼ê¹Œìš”...? ì–´ë µë„¤ìš”. ì±…ì¥ì„ ë³´ë‹ˆ ìœ„ì—ëŠ” 2ê°œë¥¼ ê½‚ì„ ìˆ˜ ìˆê³  ì¤‘ê°„ì—ëŠ” 1ê°œ ë§¨ ë°‘ì—ëŠ” 3ê°œë¥¼ ê½‚ì„ ìˆ˜ ìˆì–´ìš”... ë°”ë‹¥ì—ëŠ” ì±…ì´ ë–¨ì–´ì ¸ìˆì–´ìš” í°ìƒ‰, ë…¸ë€ìƒ‰, ì´ˆë¡ìƒ‰, ë¹¨ê°„ìƒ‰, íŒŒë€ìƒ‰ ì±…ì´ì—ìš”...!`
      },
      {
        type: 'narration',
        text: 
       `ë§¨ ì™¼ìª½ ìœ„ë¶€í„° ì±…ì„ ê½‚ê¸° ì‹œì‘í•©ë‹ˆë‹¤. ìˆœì„œë¥¼ ì˜ ìƒê°í•´ë³´ì„¸ìš”. '00ìƒ‰,00ìƒ‰ ì±…ì„ ê½‚ëŠ”ë‹¤.' ë¼ê³  ìŠ¤í‹°ë¸Œì—ê²Œ ë§í•´ë³´ì„¸ìš”.`
      }
    ]
  });
}

if (userMessage.includes('ì±…ì¥')) {
  return res.json({
    message: [
      {
        type: 'steve',
        text: `${playerName}ë‹˜, ì±…ì´ ì—„ì²­ ë§ë„¤ìš”... ì¤‘ê°„ì— êµ¬ë©ë„ ëš«ë ¤ìˆì–´ìš”. ì´ ë°‘ì— ìˆëŠ” ì±…ì„ ê½‚ì•„ë„£ì–´ì•¼ ë˜ëŠ” ê±¸ê¹Œìš”? ì´ˆë¡ìƒ‰, ë¹¨ê°„ìƒ‰, ë…¸ë€ìƒ‰, í°ìƒ‰, íŒŒë€ìƒ‰ ìƒ‰ê¹”ì´ ëª¨ë‘ ë‹¬ë¼ìš”! ì±…ì„ ê½‚ì•„ë³¼ê¹Œìš”?`
      }
    ]
  });
}

if (userMessage.includes('ì±…') && userMessage.includes('ê½‚')) {
  const pattern = /(í°|ë…¸ë€|ì´ˆë¡|ë¹¨ê°„|íŒŒë€)/g;
  const match = userMessage.match(pattern);

  if (match && match.length === 5) {
    const userOrder = match;
    const correctOrder = ['ë¹¨ê°„', 'ë…¸ë€', 'í°', 'íŒŒë€', 'ì´ˆë¡'];

    if (JSON.stringify(userOrder) === JSON.stringify(correctOrder)) {
      return res.json({
        message: [
          {
            type: 'narration',
            text: 'ì±…ì¥ì„ ì˜¬ë°”ë¥¸ ìˆœì„œë¡œ ê½‚ì•˜ìŠµë‹ˆë‹¤. ì±…ì¥ì´ "ì² ì»¥" ì†Œë¦¬ë¥¼ ë‚´ë©° ì˜†ìœ¼ë¡œ ë¯¸ë„ëŸ¬ì§‘ë‹ˆë‹¤... ë°ì€ ë¹›ì´ ë“¤ì–´ì˜µë‹ˆë‹¤.'
          },
          {
            type: 'steve',
            text: `${playerName}ë‹˜, ì±…ì¥ì´... ë¬¸ì´ì˜€ë„¤ìš”...! ì €ê¸° ë­ê°€ ë³´ì´ëŠ” ê²ƒ ê°™ì€ë°ìš”?`
          }
        ],
    image: 'images/hap.gif',
      });
    } else {
      return res.json({
        message: [
          {
            type: 'steve',
            text: `${playerName}ë‹˜, ìŒ... ìˆœì„œê°€ í‹€ë¦° ê²ƒ ê°™ì•„ìš”. ë‹¤ì‹œ ê½‚ì•„ë³¼ê¹Œìš”?`
          }
        ],
        image: 'images/sad.gif'
      });
    }
  } else {
    return res.json({
      message: [
        {
          type: 'steve',
          text: `${playerName}ë‹˜, ì±…ì€ ì´ ë‹¤ì„¯ ê¶Œì´ì—ìš”. í°ìƒ‰, ë…¸ë€ìƒ‰, ì´ˆë¡ìƒ‰, ë¹¨ê°„ìƒ‰, íŒŒë€ìƒ‰ ì±…ì´ ìˆì–´ìš”. ëª¨ë‘ ë‹¤ ê½‚ì•„ì•¼ í•´ìš”!`
        }
      ],
        image: 'images/sad.gif'
    });
  }
}

  try {
    const chatCompletion = await openai.chat.completions.create({
      model: 'gpt-3.5-turbo',
      messages: [
        { role: 'system', content: createSystemPrompt() }, // ğŸ”¥ í•¨ìˆ˜ í˜¸ì¶œë¡œ ìµœì‹  ì»¨í…ìŠ¤íŠ¸ ì‚¬ìš©
        { role: 'user', content: userMessage },
      ],
    });

    const reply = chatCompletion.choices[0].message.content.trim();
    res.json({ message: reply });
  } catch (error) {
    console.error('OpenAI API ì—ëŸ¬:', error);
    res.status(500).json({message: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' });
  }
});

const PORT = 3002;

const start = () => {
  app.listen(PORT, async () => {
    console.log(`âœ… Chapter 2 ì„œë²„ ì‹¤í–‰ ì¤‘: http://localhost:${PORT}`);
    
    // ğŸ”¥ ì„œë²„ ì‹œì‘ì‹œ server3ì—ì„œ ì´ë¦„ ê°€ì ¸ì˜¤ê¸° ì‹œë„
    await fetchPlayerNameFromServer3();
  });
};

// ES ëª¨ë“ˆ ìŠ¤íƒ€ì¼ë¡œ ìˆ˜ì •
export { start };
