<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chapter 3</title>
  <style>
    @font-face {
      font-family: 'NeoDunggeunmo';
      src: url('./NeoDunggeunmo.ttf') format('truetype');
    }

    html, body {
      margin: 0;
      padding: 0;
      background-color: black;
      font-family: 'NeoDunggeunmo', sans-serif;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    .center-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      height: 100vh;
    }

    .gif-container img {
      width: 1000px;
      max-width: 90%;
      margin-bottom: 20px;
    }

    .speaker-label {
      font-size: 20px;
      margin-bottom: 15px;
      height: 20px;
    }

    .narration-label {
      color: yellow;
    }

    .steve-label {
      color: #00bfff;
    }

    .text-line {
      font-size: 16px;
      white-space: nowrap;
      overflow: hidden;
      height: 24px;
    }

    .narration {
      color: yellow;
      white-space: normal;
      overflow: visible;
      height: auto;
    }

    .steve {
      color: #00bfff;
    }

    .cursor {
      display: inline-block;
      width: 8px;
      height: 18px;
      background-color: currentColor;
      animation: blink 0.8s infinite;
      vertical-align: bottom;
    }

    @keyframes blink {
      0%, 50% { opacity: 1; }
      50.1%, 100% { opacity: 0; }
    }

    .input-container {
      display: none;
      animation: fadeIn 0.5s ease-in forwards;
      gap: 10px;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }

    input[type="text"] {
      padding: 6px 10px;
      font-size: 14px;
      font-family: 'NeoDunggeunmo', sans-serif;
      border: 2px solid #0ff;
      background: black;
      color: #0ff;
      outline: none;
      width: 300px;
    }

    button {
      padding: 6px 12px;
      font-family: 'NeoDunggeunmo', sans-serif;
      font-size: 14px;
      background-color: #0ff;
      color: black;
      border: none;
      cursor: pointer;
    }

    button:hover {
      background-color: #ff00ff;
    }

    /* ì„ íƒ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .choice-buttons {
      margin-top: 10px;
      display: flex;
      gap: 20px;
    }

    .choice-buttons button {
      padding: 15px 30px;
      font-size: 18px;
      background-color: #0ff;
      color: black;
      border: none;
      cursor: pointer;
      width: 200px;
    }

    .choice-buttons button:hover {
      background-color: #ff00ff;
    }

    /* í™•ì¸ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
    .confirm-button {
      padding: 10px 20px;
      font-size: 16px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin: 10px auto;
      display: inline-block;
      font-family: 'NeoDunggeunmo', sans-serif;
    }

    .confirm-button:hover {
      background-color: #45a049;
    }

    .steve-choice-button {
      padding: 10px 20px;
      font-size: 16px;
      background-color: #00bfff;
      color: black;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin: 10px;
      display: inline-block;
      font-family: 'NeoDunggeunmo', sans-serif;
    }

    .steve-choice-button:hover {
      background-color: #ff00ff;
      color: white;
    }

    .button-container {
      text-align: center;
      margin-top: 20px;
    }

    #main-gif.fullscreen {
      width: 100%;
      height: 100%;
      display: block;
      margin: auto;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1;
    }

    #main-gif.hover-preview {
      width: 1000px;
      max-width: 90%;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1;
    }

    .fullscreen {
      width: 100%;
      height: 100%;
      object-fit: cover;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 1;
    }

    .text-overlay {
      position: absolute;
      top: 45%;
      left: 49%;
      transform: translate(-50%, -50%);
      font-size: 30px;
      color: #0ff;
      text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.7);
      font-family: 'NeoDunggeunmo', sans-serif;
      z-index: 2;
    }

    #text-box {
      z-index: 0;
      margin-bottom: 20px;
    }

    #retry_button {
      margin-top: 50px;
    }

    #achievementPopup {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #0ff;
      color: rgb(0, 0, 0);
      padding: 0 12px;
      border-radius: 8px;
      font-family: 'NeoDunggeunmo', sans-serif;
      font-size: 14px;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.5s ease;
      z-index: 100;
      max-width: 450px;
      height: 60px;
      line-height: 60px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      text-align: center;
    }

    #achievementPopup.show {
      transform: translateY(0);
      opacity: 1;
    }

    #choice-video {
      max-width: 90%;
    }

    #skip-button {
      padding: 6px 14px;
      font-size: 14px;
      font-family: 'NeoDunggeunmo', sans-serif;
      background-color: rgba(0,255,255,0.8);
      color: black;
      border: none;
      cursor: pointer;
      border-radius: 6px;
      box-shadow: 0 0 8px rgba(0,255,255,0.5);
    }

    #skip-button:hover {
      background-color: magenta;
      color: white;
    }

    #choice-video.fullscreen-video {
      max-width: 100%;
      max-height: 100vh;
      width: 100vw;
      height: 100vh;
      object-fit: cover;
    }

    /* ê°•í™”ëœ ê¸€ë¦¬ì¹˜ íš¨ê³¼ ì• ë‹ˆë©”ì´ì…˜ */
    @keyframes bigGlitch {
      0% { 
        background-position: 0 0, 0 0, 0 0, 0 0; 
        filter: hue-rotate(180deg) contrast(1) brightness(1); 
        transform: translate(0px, 0px); 
      }
      10% { 
        background-position: -20px 0, 0 -15px, -10px -5px, 15px 10px; 
        filter: hue-rotate(270deg) contrast(1.5) brightness(1.5); 
        transform: translate(5px, -3px); 
      }
      20% { 
        background-position: -15px -20px, -10px 5px, 15px -10px, -20px 15px; 
        filter: hue-rotate(300deg) contrast(2) brightness(0.8); 
        transform: translate(-3px, 4px); 
      }
      30% { 
        background-position: 10px 15px, 20px -10px, -5px 20px, 25px -25px; 
        filter: hue-rotate(240deg) contrast(1.8) brightness(2); 
        transform: translate(2px, -5px); 
      }
      40% { 
        background-position: 25px -5px, -5px 25px, 10px 5px, -15px 20px; 
        filter: hue-rotate(200deg) contrast(0.8) brightness(1.2); 
        transform: translate(-4px, 3px); 
      }
      50% { 
        background-position: -10px 10px, 15px -20px, -20px 15px, 20px -10px; 
        filter: hue-rotate(320deg) contrast(2.5) brightness(0.6); 
        transform: translate(6px, -2px); 
      }
      60% { 
        background-position: 5px -15px, -25px 0px, 20px -25px, -25px -25px; 
        filter: hue-rotate(280deg) contrast(1.3) brightness(1.8); 
        transform: translate(-2px, 5px); 
      }
      70% { 
        background-position: -20px 5px, 10px 20px, -15px 10px, 10px 25px; 
        filter: hue-rotate(220deg) contrast(0.5) brightness(2.2); 
        transform: translate(4px, -4px); 
      }
      80% { 
        background-position: 15px 20px, -15px -15px, 25px 0px, 0px -20px; 
        filter: hue-rotate(260deg) contrast(2.2) brightness(0.9); 
        transform: translate(-5px, 2px); 
      }
      90% { 
        background-position: 0px -25px, 25px 5px, 5px -20px, -10px 5px; 
        filter: hue-rotate(340deg) contrast(1.6) brightness(1.4); 
        transform: translate(3px, 6px); 
      }
      100% { 
        background-position: 0 0, 0 0, 0 0, 0 0; 
        filter: hue-rotate(180deg) contrast(1) brightness(1); 
        transform: translate(0px, 0px); 
      }
    }

    @keyframes flash {
      0% { opacity: 0.6; }
      25% { opacity: 0.9; }
      50% { opacity: 0.4; }
      75% { opacity: 0.8; }
      100% { opacity: 0.7; }
    }

    @keyframes flicker {
      0% { opacity: 0.2; }
      20% { opacity: 0.6; }
      40% { opacity: 0.1; }
      60% { opacity: 0.7; }
      80% { opacity: 0.3; }
      100% { opacity: 0.5; }
    }
  </style>
</head>
<body>
  <div class="center-wrapper">
    <div class="gif-container">
      <img id="main-gif" src="Chp3.gif" alt="Chapter 3 GIF">
    </div>

    <div id="speaker-label" class="speaker-label narration-label">ë‚˜ë ˆì´ì…˜</div>
    <div id="text-box" class="text-line narration"></div>

    <div id="input-container" class="input-container">
      <input type="text" placeholder="ì…ë ¥í•˜ì„¸ìš”...">
      <button>ë³´ë‚´ê¸°</button>
    </div>

    <button id="skip-button" style="display:none;">
      â–¶ SKIP
    </button>

    <div id="achievementPopup" class="achievement-popup"></div>

    <div id="choice-buttons" class="choice-buttons" style="display: none;">
      <button id="choice1" class="choice-button">ìŠ¤í‹°ë¸Œê°€ ëœë‹¤.</button>
      <button id="choice2" class="choice-button">ìŠ¤í‹°ë¸Œê°€ ë˜ì§€ ì•ŠëŠ”ë‹¤.</button>
      <button id="choice3" class="choice-button" style="display: none;">ì§„ì‹¤ì„ ë“£ëŠ”ë‹¤.</button>
    </div>

    <div id="choice-narration" class="choice-narration" style="display: none;">
      <div id="choice-narration-text" class="text-line narration yellow-text"></div>
    </div>

    <div id="video-container" style="display: none;">
      <video id="choice-video" controls></video>
      <div id="video-caption"></div>
    </div>

    <!-- YouTube iframe for choice 3 -->
    <div id="youtube-wrapper" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; background: black; overflow: hidden;">
      <iframe id="youtube-video" 
              width="100%" 
              height="100%" 
              style="border: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);" 
              frameborder="0" 
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
              allowfullscreen>
      </iframe>
    </div>

    <!-- í™”ë©´ ì „í™˜ íš¨ê³¼ -->
    <div id="screen-glitch" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2000; background: black;">
      <div class="glitch-effect" style="width: 100%; height: 100%; 
           background: 
             repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(255,255,255,0.2) 2px, rgba(255,255,255,0.2) 3px),
             repeating-linear-gradient(90deg, transparent, transparent 1px, rgba(0,255,255,0.8) 1px, rgba(0,255,255,0.8) 4px),
             repeating-linear-gradient(45deg, transparent, transparent 2px, rgba(255,0,255,0.7) 2px, rgba(255,0,255,0.7) 6px),
             repeating-linear-gradient(135deg, transparent, transparent 1px, rgba(0,100,255,0.6) 1px, rgba(0,100,255,0.6) 5px);
           animation: bigGlitch 0.1s infinite, flash 0.05s infinite;
           mix-blend-mode: screen;">
      </div>
      <div class="glitch-overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
           background: radial-gradient(circle, rgba(0,255,255,0.1) 30%, rgba(255,0,255,0.2) 70%);
           animation: flicker 0.08s infinite;">
      </div>
    </div>

    <button id="retry-button" style="display: none;">ë‹¤ì‹œ í•˜ê¸°</button>
  </div>

<script>
let playerName = localStorage.getItem('playerName') || '';

async function sendMessageToServer(message, name = '') {
  const response = await fetch('/chapter3', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ message, name })
  });

  const data = await response.json();

  if (!playerName) {
    fetch('/chapter3')
      .then(res => res.json())
      .then(data => {
        playerName = data.name;
      });
  }

  return data.reply;
}

function showTextForFiveSeconds() {
  const textElement = document.createElement('div');
  textElement.className = 'text-overlay';
  textElement.textContent = `[${playerName}]`;
  document.body.appendChild(textElement);
  setTimeout(() => textElement.remove(), 5000);
}

const narrationMessage = '[ë°©ì„ íƒˆì¶œí•˜ì‹  ê²ƒì„ ì¶•í•˜í•©ë‹ˆë‹¤. ë‹¹ì‹ ì˜ ëŠ¥ë ¥ì´ ì˜ ë³´ì´ëŠ” íƒˆì¶œì´ì—ˆìŠµë‹ˆë‹¤. \n ì´ ì‹¤í—˜ì²´ëŠ” ë‹¹ì‹ ì„ ì•„ì£¼ ì˜ ë”°ë¥´ëŠ” ê²ƒ ê°™ë„¤ìš”.]';

// ğŸ”¥ í•¨ìˆ˜ë¡œ ë³€ê²½í•˜ì—¬ ë™ì ìœ¼ë¡œ playerName ì‚¬ìš©
function getSteveMessage() {
  return `[99..? ì–´..?  ${playerName}...? ë‹¹ì‹  ì´ë¦„ì´ì–ì•„ìš”.  ì € ì‚¬ëŒì´ ì–´ë–»ê²Œ ë‹¹ì‹ ì„ ì•„ëŠ” ê±°ì£ ? \n ì ˆ ê°€ë‘” ê±´ ëª¨ë‘ ë‹¹ì‹ ì´ì—ˆë‚˜ìš”?]`;
}

const finalNarration = 'ìŠ¤í‹°ë¸Œë¥¼ ìë¦¬ë¥¼ ëŒ€ì²´í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ë‹¹ì‹ ì˜ ììœ ëŠ” ìƒê²Œë  ê±°ì˜ˆìš”. ëŒ€ì‹  ìš©ê°í•œ ë‹¹ì‹ ì€ ë¯¸ë˜ë¥¼ ìœ„í•œ ì˜ë¯¸ ìˆëŠ” ì‹¤í—˜ìœ¼ë¡œ ë‚¨ê² ì£ .';

const choice1Narration = '...ë‚˜ë„ ê²°êµ­ ëˆ„êµ°ê°€ì˜ ì„ íƒì´ì—ˆêµ°ìš”. ì´ì œ ë‹¹ì‹ ì´ ì ˆ ëŒ€ì‹ í•  ì°¨ë¡€ì¸ê°€ìš”? í–‰ìš´ì„ ë¹Œì–´ìš”.';
const choice2Narration = 'ë‹¹ì‹ ì€ ììœ ë¥¼ ì–»ì—ˆìŠµë‹ˆë‹¤. ê·¸ë¦¬ê³  ìŠ¤í‹°ë¸ŒëŠ”... ê·¸ëŠ”... ë‹¹ì‹ ì˜ ê¸°ì–µ ì†ì— ë‚¨ì•„ìˆê² ì£ . ì•„ë‹ˆë©´ ê·¸ì € ë‹¹ì‹ ì˜ ê¿ˆì´ì—ˆì„ì§€ë„.';
const choice3Narration = 'ê¸°ì–µì„ í…ŒìŠ¤íŠ¸ ì´ì „ìœ¼ë¡œ ë³µêµ¬ë©ë‹ˆë‹¤.';

// ğŸ”¥ ë™ì  ë©”ì‹œì§€ í•¨ìˆ˜ë“¤ ì¶”ê°€
function getSystemDeletionMessage() {
  return `ê·¸ëŸ¼ ì•ˆë…•. [${playerName}]`;
}

function getFinalPopupMessage() {
  return `ğŸ–ï¸ ì´ì œ ì•ˆë…• [${playerName}]`;
}

const speakerLabel = document.getElementById('speaker-label');
const textBox = document.getElementById('text-box');
const inputContainer = document.getElementById('input-container');
const input = document.querySelector('input');
const button = document.querySelector('button');
const choiceButtons = document.getElementById('choice-buttons');
const choice1Button = document.getElementById('choice1');
const choice2Button = document.getElementById('choice2');
const choice3Button = document.getElementById('choice3');
const popup = document.getElementById('achievementPopup');
const mainGif = document.getElementById('main-gif');
const retryButton = document.getElementById('retry-button');
const choiceNarration = document.getElementById('choice-narration');
const choiceNarrationText = document.getElementById('choice-narration-text');
const skipButton = document.getElementById('skip-button');

const videoContainer = document.getElementById('video-container');
const video = document.getElementById('choice-video');
const captionBox = document.getElementById('video-caption');
const youtubeVideo = document.getElementById('youtube-video');
const youtubeWrapper = document.getElementById('youtube-wrapper');
const screenGlitch = document.getElementById('screen-glitch');

const imageSequence = ['1.png', '2.png', '3.png', '4.png', '5.png', '6.png', '7.png', '8.png', '9.png', '10.png', '11.png', 'ë§ˆì§€ë§‰.png'];
let imageIndex = 0, index = 0, steveIndex = 0;
const cursor = document.createElement('span');
cursor.className = 'cursor';
textBox.appendChild(cursor);

let skipRequested = false;
let isChoice3Playing = false;
let isSystemDeletionPhase = false;

skipButton.addEventListener('click', () => {
  skipRequested = true;
});
// retryButton í´ë¦­ ì´ë²¤íŠ¸ ìˆ˜ì • - í•­ìƒ ì„ íƒì§€ë¡œ ëŒì•„ê°€ë„ë¡
retryButton.addEventListener('click', () => {
  // ëª¨ë“  ì»¨í…Œì´ë„ˆì™€ ìƒíƒœ ì´ˆê¸°í™”
  videoContainer.style.display = 'none';
  youtubeWrapper.style.display = 'none';
  screenGlitch.style.display = 'none';
  retryButton.style.display = 'none';
  choiceNarration.style.display = 'none';
  inputContainer.style.display = 'none';
  
  // ì‹œìŠ¤í…œ ì‚­ì œ ê´€ë ¨ ìƒíƒœ ì´ˆê¸°í™”
  isSystemDeletionPhase = false;
  isChoice3Playing = false;
  
  // ê¸°ì¡´ ë²„íŠ¼ ì»¨í…Œì´ë„ˆë“¤ ì œê±°
  const existingContainers = document.querySelectorAll('.steve-button-container, .confirmation-button-container');
  existingContainers.forEach(container => container.remove());
  
  // GIFë¥¼ ì›ë˜ ìƒíƒœë¡œ ë³µì›
  mainGif.style.display = 'block';
  mainGif.src = 'Chp3.gif';
  mainGif.className = '';
  
  // UI ìš”ì†Œë“¤ ë‹¤ì‹œ í‘œì‹œ
  speakerLabel.style.display = 'block';
  speakerLabel.textContent = 'ë‚˜ë ˆì´ì…˜';
  speakerLabel.className = 'speaker-label narration-label';
  
  textBox.style.display = 'block';
  textBox.className = 'text-line narration';
  textBox.textContent = finalNarration;
  
  // input placeholder ì›ë˜ëŒ€ë¡œ ë³µì›
  input.placeholder = 'ì…ë ¥í•˜ì„¸ìš”...';
  
  // ì„ íƒ ë²„íŠ¼ë“¤ ë‹¤ì‹œ í‘œì‹œ
  choiceButtons.style.display = 'flex';
  
  // center-wrapper ìŠ¤íƒ€ì¼ ì›ë˜ëŒ€ë¡œ ë³µì›
  const centerWrapper = document.querySelector('.center-wrapper');
  if (centerWrapper) {
    centerWrapper.style.justifyContent = 'center';
    centerWrapper.style.alignItems = 'center';
  }
});

function showImageSequence() {
  if (imageIndex < imageSequence.length) {
    mainGif.src = imageSequence[imageIndex];
    mainGif.classList.add('fullscreen');
    textBox.style.display = 'none';
    speakerLabel.style.display = 'none';

    const isLastImage = imageSequence[imageIndex] === 'ë§ˆì§€ë§‰.png';
    const delay = isLastImage ? 5000 : 100;
    if (isLastImage) showTextForFiveSeconds();

    imageIndex++;
    setTimeout(showImageSequence, delay);
  } else {
    mainGif.classList.remove('fullscreen');
    mainGif.src = 'Chp3.gif';
    textBox.style.display = 'block';
    speakerLabel.style.display = 'block';
    setTimeout(startSteve, 1000);
  }
}

function typeNarration() {
  skipRequested = false;
  skipButton.style.display = 'inline';

  function step() {
    if (skipRequested) {
      textBox.textContent = narrationMessage;
      cursor.remove();
      skipButton.style.display = 'none';
      setTimeout(showImageSequence, 500);
      return;
    }

    if (index < narrationMessage.length) {
      cursor.insertAdjacentText('beforebegin', narrationMessage[index++]);
      setTimeout(step, 40);
    } else {
      cursor.remove();
      // SKIP ë²„íŠ¼ì„ í…ìŠ¤íŠ¸ ì™„ë£Œ í›„ 1ì´ˆ ë” ìœ ì§€
      setTimeout(() => {
        skipButton.style.display = 'none';
        setTimeout(showImageSequence, 1000);
      }, 1000);
    }
  }

  step();
}

function startSteve() {
  skipRequested = false;
  skipButton.style.display = 'inline';

  speakerLabel.textContent = 'ìŠ¤í‹°ë¸Œ';
  speakerLabel.className = 'speaker-label steve-label';
  textBox.innerHTML = '';
  textBox.className = 'text-line steve';

  const steveCursor = document.createElement('span');
  steveCursor.className = 'cursor';
  textBox.appendChild(steveCursor);

  // ğŸ”¥ í•¨ìˆ˜ í˜¸ì¶œë¡œ ìµœì‹  playerName ë°˜ì˜
  const currentSteveMessage = getSteveMessage();
  steveIndex = 0; // ì¸ë±ìŠ¤ ì´ˆê¸°í™”

  function typeSteve() {
    if (skipRequested) {
      textBox.textContent = currentSteveMessage;
      steveCursor.remove();
      skipButton.style.display = 'none';
      setTimeout(() => inputContainer.style.display = 'flex', 500);
      return;
    }

    if (steveIndex < currentSteveMessage.length) {
      steveCursor.insertAdjacentText('beforebegin', currentSteveMessage[steveIndex++]);
      setTimeout(typeSteve, 40);
    } else {
      steveCursor.remove();
      // SKIP ë²„íŠ¼ì„ í…ìŠ¤íŠ¸ ì™„ë£Œ í›„ 5ì´ˆ ë” ìœ ì§€
      setTimeout(() => {
        skipButton.style.display = 'none';
        setTimeout(() => inputContainer.style.display = 'flex', 5000);
      }, 1000);
    }
  }
  typeSteve();
}

button.addEventListener('click', handleUserInput);
input.addEventListener('keypress', e => { if (e.key === 'Enter') button.click(); });

function handleUserInput() {
  const userInput = input.value.trim();
  if (!userInput) return;

  if (isSystemDeletionPhase) {
    handleSystemDeletionInput(userInput);
    return;
  }

  let reply = '';
  if (userInput.includes('ì£„ì†¡')) {
    reply = 'ì£„ì†¡í•˜ë‹¤ê³ ìš”? ë‹¹ì‹ ì´ ì €ë¥¼ ê°€ë‘ê³  ì €ë¥¼ ì´ë ‡ê²Œ ë§Œë“¤ì—ˆì–ì•„ìš”. ì±…ì„ì§€ì„¸ìš”.';
  } else if (userInput.includes('ë¯¸ì•ˆ')) {
    reply = '...ë¯¸ì•ˆí•œ ë§ˆìŒì€ ê±°ì§“ë§ì´ ì•„ë‹ˆì£ ? ê·¸ë ‡ë‹¤ê³  í•´ì£¼ì„¸ìš”.';
  } else if (userInput.includes('ëª°ë¼')) {
    reply = 'ê±°ì§“ë§... ì ˆ ì´ë ‡ê²Œ ê°€ì§€ê³  ë†€ì•˜ë˜ê±°ì£ ?';
  } else if (userInput.includes('ë§ì•„') || userInput.includes('ë‚´ê°€ í–ˆì–´') || userInput.includes('ë‚˜ì•¼')) {
    reply = 'ëŒ€ì²´ ì™œ ....? ì™œ ë‚˜ì—¬ì•¼ë§Œ í–ˆì–´? ì™œ?';
    choice3Button.style.display = 'inline-block';
    showPopup('ğŸ–ï¸ ë‹¤ ì•Œê³  ìˆì—ˆì–´?');
  } else {
    reply = '...ê·¸ê²Œ ë‹¹ì‹ ì˜ ëŒ€ë‹µì¸ê°€ìš”.';
  }

  inputContainer.style.display = 'none';
  speakerLabel.textContent = 'ìŠ¤í‹°ë¸Œ';
  speakerLabel.className = 'speaker-label steve-label';
  textBox.className = 'text-line steve';
  textBox.textContent = '';

  let idx = 0;
  skipRequested = false;
  skipButton.style.display = 'inline';

  function typeReply() {
    if (skipRequested) {
      textBox.textContent = reply;
      skipButton.style.display = 'none';
      setTimeout(showFinalNarration, 500);
      return;
    }

    if (idx < reply.length) {
      textBox.textContent += reply[idx++];
      setTimeout(typeReply, 40);
    } else {
      // SKIP ë²„íŠ¼ì„ í…ìŠ¤íŠ¸ ì™„ë£Œ í›„ 5ì´ˆ ë” ìœ ì§€
      setTimeout(() => {
        skipButton.style.display = 'none';
        setTimeout(showFinalNarration, 5000);
      }, 1000);
    }
  }
  input.value = '';
  typeReply();
}

function handleSystemDeletionInput(userInput) {
  input.value = '';
  
  if (userInput === 'ì‹œìŠ¤í…œì„ ì‚­ì œí•œë‹¤.' || userInput === 'ì‹œìŠ¤í…œì„ ì‚­ì œ í•œë‹¤.') {
    inputContainer.style.display = 'none';
    showSystemDeletionConfirmation();
  } else {
    // Random error message
    const errorMessages = [
      'ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”. ë‹¹ì‹  ê¸€ì„ ì˜ ëª» ì½ë‚˜ìš”?',
      'ë‹¹ì‹ ì´ ì„ íƒí•œ ê²Œ ì´ê²Œ ì•„ë‹ˆì—ˆë‚˜ìš”? ì—¬ê¸°ê¹Œì§€ ì™”ë‹¤ë©´ ì´ ì„ íƒì´ ë§ì„í…ë°...'
    ];
    const randomMessage = errorMessages[Math.floor(Math.random() * errorMessages.length)];
    
    inputContainer.style.display = 'none';
    speakerLabel.textContent = 'ìŠ¤í‹°ë¸Œ';
    speakerLabel.className = 'speaker-label steve-label';
    textBox.className = 'text-line steve';
    textBox.textContent = '';
    
    typeText(randomMessage, () => {
      // Show choice buttons for Steve decision - keep text box visible
      showSteveChoiceButtons();
    });
  }
}

function showSteveChoiceButtons() {
  // Remove any existing button containers
  const existingContainer = document.querySelector('.steve-button-container');
  if (existingContainer) {
    existingContainer.remove();
  }

  // GIF ìˆ¨ê¸°ê¸°
  mainGif.style.display = 'none';

  // Keep text box and input visible and centered
  textBox.style.display = 'block';
  speakerLabel.style.display = 'block';
  inputContainer.style.display = 'flex';

  // ì¤‘ì•™ ì •ë ¬ ë³´ì¥
  const centerWrapper = document.querySelector('.center-wrapper');
  if (centerWrapper) {
    centerWrapper.style.justifyContent = 'center';
    centerWrapper.style.alignItems = 'center';
  }

  // Create button container
  const buttonContainer = document.createElement('div');
  buttonContainer.className = 'steve-button-container';
  buttonContainer.style.display = 'flex';
  buttonContainer.style.justifyContent = 'center';
  buttonContainer.style.gap = '20px';
  buttonContainer.style.marginTop = '20px';
  buttonContainer.style.position = 'fixed';
  buttonContainer.style.bottom = '160px';
  buttonContainer.style.left = '50%';
  buttonContainer.style.transform = 'translateX(-50%)';
  buttonContainer.style.zIndex = '1000';
  
  // Create buttons with CSS matching existing choice buttons
  const becomeButton = document.createElement('button');
  becomeButton.textContent = 'ìŠ¤í‹°ë¸Œê°€ ëœë‹¤';
  becomeButton.className = 'steve-choice-button';
  becomeButton.style.padding = '15px 30px';
  becomeButton.style.fontSize = '18px';
  becomeButton.style.backgroundColor = '#0ff';
  becomeButton.style.color = 'black';
  becomeButton.style.border = 'none';
  becomeButton.style.cursor = 'pointer';
  becomeButton.style.width = '200px';
  becomeButton.style.fontFamily = "'NeoDunggeunmo', sans-serif";
  
  const notBecomeButton = document.createElement('button');
  notBecomeButton.textContent = 'ìŠ¤í‹°ë¸Œê°€ ë˜ì§€ ì•ŠëŠ”ë‹¤';
  notBecomeButton.className = 'steve-choice-button';
  notBecomeButton.style.padding = '15px 30px';
  notBecomeButton.style.fontSize = '18px';
  notBecomeButton.style.backgroundColor = '#0ff';
  notBecomeButton.style.color = 'black';
  notBecomeButton.style.border = 'none';
  notBecomeButton.style.cursor = 'pointer';
  notBecomeButton.style.width = '200px';
  notBecomeButton.style.fontFamily = "'NeoDunggeunmo', sans-serif";
  
  // Add hover effects matching existing CSS
  becomeButton.addEventListener('mouseenter', () => {
    becomeButton.style.backgroundColor = '#ff00ff';
    becomeButton.style.color = 'white';
  });
  becomeButton.addEventListener('mouseleave', () => {
    becomeButton.style.backgroundColor = '#0ff';
    becomeButton.style.color = 'black';
  });
  
  notBecomeButton.addEventListener('mouseenter', () => {
    notBecomeButton.style.backgroundColor = '#ff00ff';
    notBecomeButton.style.color = 'white';
  });
  notBecomeButton.addEventListener('mouseleave', () => {
    notBecomeButton.style.backgroundColor = '#0ff';
    notBecomeButton.style.color = 'black';
  });
  
  buttonContainer.appendChild(becomeButton);
  buttonContainer.appendChild(notBecomeButton);
  document.body.appendChild(buttonContainer);
  
  becomeButton.addEventListener('click', () => {
    buttonContainer.remove();
    showSystemDeletionInput();
  });
  
  notBecomeButton.addEventListener('click', () => {
    buttonContainer.remove();
    showSystemDeletionInput();
  });
}

// showSystemDeletionInput í•¨ìˆ˜ ìˆ˜ì • - ì¤‘ì•™ ì •ë ¬ ë³´ì¥
function showSystemDeletionInput() {
  // Remove any existing button containers
  const existingContainer = document.querySelector('.steve-button-container');
  if (existingContainer) {
    existingContainer.remove();
  }

  isSystemDeletionPhase = true;
  
  // GIF ìˆ¨ê¸°ê¸°
  mainGif.style.display = 'none';
  
  // í…ìŠ¤íŠ¸ì™€ ì…ë ¥ ìš”ì†Œë“¤ì„ ì¤‘ì•™ì— í‘œì‹œ
  textBox.style.display = 'block';
  speakerLabel.style.display = 'block';
  speakerLabel.textContent = 'ë‚˜ë ˆì´ì…˜';
  speakerLabel.className = 'speaker-label narration-label';
  textBox.className = 'text-line narration';
  textBox.textContent = '';
  
  input.placeholder = 'ì‹œìŠ¤í…œì„ ì‚­ì œ í•œë‹¤.';
  inputContainer.style.display = 'flex';
  
  // ì¤‘ì•™ ì •ë ¬ì„ ìœ„í•œ ìŠ¤íƒ€ì¼ ì¶”ê°€
  const centerWrapper = document.querySelector('.center-wrapper');
  if (centerWrapper) {
    centerWrapper.style.justifyContent = 'center';
    centerWrapper.style.alignItems = 'center';
  }
}

function showSystemDeletionConfirmation() {
  speakerLabel.textContent = 'ë‚˜ë ˆì´ì…˜';
  speakerLabel.className = 'speaker-label narration-label';
  textBox.className = 'text-line narration';
  textBox.textContent = '';
  
  typeText('ì •ë§ ì‚­ì œ í•˜ì‹¤ ê±´ê°€ìš”?', () => {
    showConfirmationButton('first');
  });
}

function showConfirmationButton(stage) {
  // Remove any existing button containers
  const existingContainer = document.querySelector('.confirmation-button-container');
  if (existingContainer) {
    existingContainer.remove();
  }

  // Create button container
  const buttonContainer = document.createElement('div');
  buttonContainer.className = 'confirmation-button-container';
  buttonContainer.style.display = 'flex';
  buttonContainer.style.justifyContent = 'center';
  buttonContainer.style.marginTop = '20px';
  buttonContainer.style.position = 'fixed';
  buttonContainer.style.bottom = '100px';
  buttonContainer.style.left = '50%';
  buttonContainer.style.transform = 'translateX(-50%)';
  buttonContainer.style.zIndex = '1000';
  
  // Create confirmation button with similar styling
  const confirmButton = document.createElement('button');
  confirmButton.textContent = 'ë„¤';
  confirmButton.style.padding = '10px 30px';
  confirmButton.style.fontSize = '16px';
  confirmButton.style.backgroundColor = '#4a4a4a';
  confirmButton.style.color = 'white';
  confirmButton.style.border = '2px solid #666';
  confirmButton.style.borderRadius = '5px';
  confirmButton.style.cursor = 'pointer';
  confirmButton.style.transition = 'all 0.3s ease';
  
  // Add hover effect
  confirmButton.addEventListener('mouseenter', () => {
    confirmButton.style.backgroundColor = '#666';
    confirmButton.style.borderColor = '#888';
  });
  confirmButton.addEventListener('mouseleave', () => {
    confirmButton.style.backgroundColor = '#4a4a4a';
    confirmButton.style.borderColor = '#666';
  });
  
  buttonContainer.appendChild(confirmButton);
  document.body.appendChild(buttonContainer);
  
  confirmButton.addEventListener('click', () => {
    buttonContainer.remove();
    
    if (stage === 'first') {
      typeText('ì •ë§ìš”?', () => {
        showConfirmationButton('second');
      });
    } else if (stage === 'second') {
      typeText('ë§ˆìŒì„ ì •ë§ ë¨¹ìœ¼ì…¨êµ°ìš”.', () => {
        setTimeout(() => {
          // ğŸ”¥ í•¨ìˆ˜ í˜¸ì¶œë¡œ ìµœì‹  playerName ë°˜ì˜
          typeText(getSystemDeletionMessage(), () => {
            // Show final image and popup
            setTimeout(() => {
              // Remove any remaining button containers
              const confirmationContainer = document.querySelector('.confirmation-button-container');
              if (confirmationContainer) {
                confirmationContainer.remove();
              }
              const steveContainer = document.querySelector('.steve-button-container');
              if (steveContainer) {
                steveContainer.remove();
              }
              
              // Hide all UI elements
              textBox.style.display = 'none';
              speakerLabel.style.display = 'none';
              inputContainer.style.display = 'none';
              choiceButtons.style.display = 'none';
              
              // Show final image
              mainGif.src = 'ã„¸.png';
              mainGif.style.display = 'block';
              mainGif.className = 'fullscreen';
              
              // Show final popup after delay
              setTimeout(() => {
                // ğŸ”¥ í•¨ìˆ˜ í˜¸ì¶œë¡œ ìµœì‹  playerName ë°˜ì˜
                showPopup(getFinalPopupMessage());
              }, 2000);
            }, 2000);
          });
        }, 1000);
      });
    }
  });
}

function typeText(text, callback) {
  textBox.textContent = '';
  let idx = 0;
  
  function typeChar() {
    if (idx < text.length) {
      textBox.textContent += text[idx++];
      setTimeout(typeChar, 40);
    } else if (callback) {
      setTimeout(callback, 1000);
    }
  }
  typeChar();
}

function showFinalNarration() {
  speakerLabel.textContent = 'ë‚˜ë ˆì´ì…˜';
  speakerLabel.className = 'speaker-label narration-label';
  textBox.className = 'text-line narration';
  textBox.textContent = '';

  let idx = 0;
  skipRequested = false;
  skipButton.style.display = 'inline';

  function typeNarr() {
    if (skipRequested) {
      textBox.textContent = finalNarration;
      skipButton.style.display = 'none';
      setTimeout(() => choiceButtons.style.display = 'flex', 500);
      return;
    }

    if (idx < finalNarration.length) {
      textBox.textContent += finalNarration[idx++];
      setTimeout(typeNarr, 40);
    } else {
      // SKIP ë²„íŠ¼ì„ í…ìŠ¤íŠ¸ ì™„ë£Œ í›„ 2ì´ˆ ë” ìœ ì§€
      setTimeout(() => {
        skipButton.style.display = 'none';
        setTimeout(() => choiceButtons.style.display = 'flex', 2000);
      }, 1000);
    }
  }
  typeNarr();
}

function showPopup(message) {
  popup.textContent = message;
  popup.classList.add('show');
  setTimeout(() => popup.classList.remove('show'), 4000);
}

function typeChoiceNarration(text, callback) {
  choiceButtons.style.display = 'none';
  textBox.style.display = 'none';
  speakerLabel.style.display = 'none';
  mainGif.style.display = 'none';

  choiceNarrationText.textContent = '';
  choiceNarration.style.display = 'block';

  let idx = 0;
  function typeChar() {
    if (idx < text.length) {
      choiceNarrationText.textContent += text[idx++];
      setTimeout(typeChar, 40);
    } else {
      setTimeout(callback, 2000);
    }
  }
  typeChar();
}

function playVideoWithCaption(src, caption, isChoice3 = false) {
  choiceNarration.style.display = 'none';
  
  if (isChoice3) {
    // Choice 3ì˜ ê²½ìš° YouTube ì˜ìƒ ì¬ìƒ (UI ì™„ì „ ìˆ¨ê¹€)
    youtubeVideo.src = 'https://www.youtube.com/embed/3Jh6S8E-5A4?autoplay=1&controls=0&showinfo=0&rel=0&modestbranding=1&iv_load_policy=3&cc_load_policy=0&fs=0&disablekb=1&start=0';
    youtubeWrapper.style.display = 'block';
    isChoice3Playing = true;
    retryButton.style.display = 'block';
    
    // 30ì´ˆ í›„ ê¸€ë¦¬ì¹˜ íš¨ê³¼ì™€ í•¨ê»˜ ì „í™˜
    setTimeout(() => {
      if (isChoice3Playing) {
        // ê¸€ë¦¬ì¹˜ íš¨ê³¼ ì‹œì‘
        screenGlitch.style.display = 'block';
        
        // 1ì´ˆ í›„ ê¸€ë¦¬ì¹˜ íš¨ê³¼ ëë‚´ê³  ë‹¤ìŒ í™”ë©´ìœ¼ë¡œ
        setTimeout(() => {
          youtubeWrapper.style.display = 'none';
          screenGlitch.style.display = 'none';
          retryButton.style.display = 'none';
          mainGif.style.display = 'none';
          showSystemDeletionInput();
          isChoice3Playing = false;
        }, 1000);
      }
    }, 30000); // 30ì´ˆ í›„ ì „í™˜ ì‹œì‘
    
  } else {
    // Choice 1, 2ì˜ ê²½ìš° ì¼ë°˜ ë¹„ë””ì˜¤ ì¬ìƒ
    videoContainer.style.display = 'block';
    video.src = src;
    video.className = '';
    video.play();
    captionBox.textContent = caption;
    retryButton.style.display = 'block';
    isChoice3Playing = false;

    video.onended = () => {
      // ì¼ë°˜ ì˜ìƒ ì¢…ë£Œ ì‹œì—ëŠ” ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•ŠìŒ (ë‹¤ì‹œí•˜ê¸° ë²„íŠ¼ë§Œ í‘œì‹œ)
    };
  }
}

const hoverText1 = 'ìŠ¤í‹°ë¸Œë¥¼ ìë¦¬ë¥¼ ëŒ€ì²´í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ë‹¹ì‹ ì˜ ììœ ëŠ” ìƒê²Œë  ê±°ì˜ˆìš”. ëŒ€ì‹  ìš©ê°í•œ ë‹¹ì‹ ì€ ë¯¸ë˜ë¥¼ ìœ„í•œ ì˜ë¯¸ ìˆëŠ” ì‹¤í—˜ìœ¼ë¡œ ë‚¨ê² ì£ .';
const hoverText2 = 'ìŠ¤í‹°ë¸Œì˜ ê¸°ì–µì„ ì§€ìš°ê³  ë‹¤ë¥¸ ì‚¬ëŒì—ê²Œ ì‹¤í—˜ì„ ë§¡ê¸°ì‹œê² ì–´ìš”? í•˜í•˜. ê²ìŸì´.';
const hoverText3 = 'ë‹¹ì‹ ì€ ëª¨ë“  ê±¸ ì•Œê³  ìˆì—ˆêµ°ìš”?';
let currentHover = null;

choice1Button.addEventListener('mouseenter', () => {
  if (currentHover !== 'choice1') {
    speakerLabel.className = 'speaker-label narration-label';
    textBox.className = 'text-line narration';
    textBox.textContent = hoverText1;
    mainGif.src = '99-100.gif';
    mainGif.className = 'hover-preview';
    currentHover = 'choice1';
  }
});

choice2Button.addEventListener('mouseenter', () => {
  if (currentHover !== 'choice2') {
    speakerLabel.className = 'speaker-label narration-label';
    textBox.className = 'text-line narration';
    textBox.textContent = hoverText2;
    mainGif.src = '99-98.gif';
    mainGif.className = 'hover-preview';
    currentHover = 'choice2';
  }
});

choice3Button.addEventListener('mouseenter', () => {
  if (currentHover !== 'choice3') {
    speakerLabel.className = 'speaker-label narration-label';
    textBox.className = 'text-line narration';
    textBox.textContent = hoverText3;
    mainGif.src = 'true.png';
    mainGif.className = 'hover-preview';
    currentHover = 'choice3';
  }
});

choice1Button.addEventListener('click', () => {
  typeChoiceNarration(choice1Narration, () => {
    playVideoWithCaption('pick1.mp4', choice1Narration, false);
    showPopup('ğŸ–ï¸ Normal Ending. ë¯¸ë˜ì˜ êµ¬ì›ì');
  });
});

choice2Button.addEventListener('click', () => {
  typeChoiceNarration(choice2Narration, () => {
    playVideoWithCaption('pick2.mp4', choice2Narration, false);
    showPopup('ğŸ–ï¸ Normal Ending. ë‚˜ìœ ì•…ëª½?');
  });
});

choice3Button.addEventListener('click', () => {
  typeChoiceNarration(choice3Narration, () => {
    playVideoWithCaption('pick3.mp4', choice3Narration, true);
    showPopup('ğŸ–ï¸ True Ending. ì§„ì‹¤');
  });
});

window.onload = async () => {
  // localStorageì—ì„œ ë¨¼ì € ì´ë¦„ í™•ì¸
  if (!playerName) {
    playerName = localStorage.getItem('playerName') || '';
  }
  
  // ì—¬ì „íˆ ì´ë¦„ì´ ì—†ìœ¼ë©´ ì„œë²„ì—ì„œ ê°€ì ¸ì˜¤ê¸° ì‹œë„
  if (!playerName) {
    try {
      const response = await fetch('/chapter3');
      const data = await response.json();
      playerName = data.name;
    } catch (error) {
      console.log('Server not available, using default name');
      playerName = '[Player]';  // ê¸°ë³¸ê°’ë„ ìˆ˜ì •
    }
  }
  typeNarration();
};
</script>
</body>
</html>
