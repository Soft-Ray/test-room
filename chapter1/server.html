<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ìŠ¤í‹°ë¸Œ ê²Œì„</title>
  <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
  <style>
    body {
      background-color: #000;
      color: #fff;
      font-family: 'VT323', 'Neoë‘¥ê·¼ëª¨', sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 90vh;
      flex-direction: column;
      text-align: center;
    }

.chapter-btn,
.dropdown-content,
#promptInput,
#responseBox,
button,
p,
h1, h2, h3 {
  font-family: 'VT323', 'Neoë‘¥ê·¼ëª¨', sans-serif;
}

    h1 {
      font-size: 8rem;
      color: #0ff;
      text-shadow: 0 0 10px #0ff, 0 0 20px #0ff;
      margin-bottom: 40px;
    }

    .game-container {
      display: flex;
      flex-direction: column;
      background-color: #111;
      padding: 40px;
      border-radius: 10px;
      box-shadow: 0 0 15px #0ff;
      width: 80%;
      max-width: 1200px;
      height: 55%;
      text-align: left;
    }

    .gif-container {
      margin-top: 10px;
      width: 100%;
      max-width: 300px;
      margin-right: 40px;
    }

    .gif-container img {
      width: 100%;
      height: auto;
      object-fit: cover;
      border-radius: 8px;
      box-shadow: 0 0 10px #0ff;
      border: 2px solid #0ff;
      color: #0ff;
    }

    .status-container {
      padding: 10px;
      font-size: 1.3rem;
      text-align: left;
      width: 100%;
      max-width: 300px;
    }

    #statusText {
      margin-top: 20px;
      font-size: 1.5rem;
      color: #0ff;
      text-shadow: 0 0 5px #0ff;
    }

    .content-container {
      display: flex;
      flex: 1;
      width: 100%;
    }

    .chat-container {
      flex: 1;
      display: flex;
      margin-top: 10px;
      flex-direction: column;
    }

    .response-box {
      padding: 20px;
      background-color: #222;
      border: 2px solid #0ff;
      color: #0ff;
      font-size: 1.5rem;
      text-align: left;
      box-shadow: 0 0 10px #0ff;
      height: 480px;
      overflow-y: auto;
      white-space: pre-wrap;
      border-radius: 8px;
    }

    .input-container {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      margin-top: 30px;
      gap: 10px;
      width: 100%;
    }

    .prompt-input {
      background: #222;
      border: 2px solid #0ff;
      color: #0ff;
      padding: 12px 20px;
      font-size: 1.5rem;
      flex: 1;
      border-radius: 5px;
      letter-spacing: 2px;
    }

    .submit-btn, .reset-btn {
      background: #0ff;
      color: #000;
      border: 2px solid #0ff;
      padding: 12px 20px;
      font-size: 1.2rem;
      cursor: pointer;
      transition: 0.3s ease;
      font-weight: bold;
      border-radius: 5px;
    }

    .submit-btn:hover, .reset-btn:hover {
      background: #ff00ff;
      box-shadow: 0 0 15px #ff00ff;
      color: #fff;
    }

    .message {
      margin-bottom: 8px;
    }

    .steve {
      color: #1e90ff;
    }

    .user {
      color: #ffffff;
    }

    .narration {
      font-style: italic;
      color: #ff0;
      margin-bottom: 10px;
    }

    .chapter-dropdown {
      position: absolute;
      top: 60px;
      left: 80px;
      z-index: 1000;
      display: none; /* ì´ ì¤„ ì¶”ê°€ë¨ - ì±•í„° ì„ íƒ ë²„íŠ¼ ìˆ¨ê¹€ */
    }

    #next-chapter-btn {
      margin-top: 40px;
      padding: 12px 24px;
      font-family: 'VT323', 'Neoë‘¥ê·¼ëª¨', sans-serif;
      font-size: 1.5rem;
      background: #0ff;
      color: #000;
      border: 2px solid #0ff;
      border-radius: 5px;
      cursor: pointer;
      opacity: 1;
      transition: opacity 0.5s;
    }
    
    #next-chapter-btn:hover {
      background: #ff00ff;
      color: #fff;
    }

    .dropdown-content {
      position: absolute;
      z-index: 9999;
      display: none;
      background-color: #111;
      border: 2px solid #0ff;
      border-top: none;
      width: 200px;
      top: 100%;
      left: 0;
      font-size: 1.1rem;
    }

    .dropdown-content div {
      color: #0ff;
      padding: 10px;
      cursor: pointer;
      border-top: 1px solid #0ff;
    }

    .dropdown-content div:hover {
      background-color: #00f;
      color: #fff;
    }

    /* í´ë¦¬ì–´ ì˜¤ë²„ë ˆì´ */
    #chapter-transition-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(0, 0, 0, 0.8);
      display: none; /* ì²˜ìŒì—” ìˆ¨ê¹€ */
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      opacity: 0;
      transition: opacity 0.5s ease-in-out;
      pointer-events: none;
    }

    #chapter-transition-text {
      font-size: 100px;
      color: #0ff;
      margin-bottom: 20px;
      font-family: 'VT323', monospace;
    }

    @keyframes slideIn {
      0%   { transform: translateY(100%); opacity: 0; }
      40%  { transform: translateY(0); opacity: 1; }
      100% { transform: translateY(0); opacity: 1; }
    }

    #game-over-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: black;
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 999;
      font-family: 'VT323', monospace;
    }

    #game-over-text {
      font-size: 80px;
      color: #FF4C4C;
      text-shadow: 0 0 10px #FF4C4C, 0 0 20px #FF4C4C;
      margin-bottom: 10px;
    }

    #game-over-message {
      font-size: 24px;
      color: #FF4C4C;
      margin-bottom: 30px;
      text-shadow: 0 0 5px #FF4C4C;
    }

    #retry-btn {
      margin-top: 40px;
      padding: 12px 24px;
      font-family: 'VT323', 'Neoë‘¥ê·¼ëª¨', sans-serif;
      font-size: 1.5rem;
      background: #FF4C4C;
      color: #000;
      border: 2px solid #FF4C4C;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s, color 0.3s;
    }

    #retry-btn:hover {
      background: #fff;
      color: #FF4C4C;
    }

    .choice-container {
  margin-top: 20px;
  display: flex;
  flex-direction: row; /* ê°€ë¡œ ë°©í–¥ìœ¼ë¡œ ì •ë ¬ */
  flex-wrap: wrap; /* í•„ìš”ì‹œ ì¤„ë°”ê¿ˆ */
  gap: 10px; /* ë²„íŠ¼ ì‚¬ì´ ê°„ê²© */
  justify-content: flex-start; /* ì™¼ìª½ ì •ë ¬ */
}

.choice-btn {
  background-color: #0ff;
  color: #000;
  padding: 10px 15px;
  border: none;
  border-radius: 5px;
  margin: 0;
  cursor: pointer;
  font-size: 16px;
  font-family: 'VT323', 'Neoë‘¥ê·¼ëª¨', sans-serif;
}

.choice-btn:hover {
  background-color: #ff00ff;
  color: #fff;
}

#sequenceDisplay {
  display: flex;
  flex-direction: row;
  gap: 10px;
  margin-top: 10px;
  padding: 5px 0;
  font-size: 20px;
  color: #00ffff;
  font-family: 'VT323', monospace;
}

/* ë©”ì‹œì§€ ì˜µì…˜ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
.message-options {
  margin-top: 15px;
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  justify-content: flex-start;
}

.option-btn {
  background-color: #0ff;
  color: #000;
  padding: 8px 16px;
  border: 2px solid #0ff;
  border-radius: 5px;
  cursor: pointer;
  font-size: 1.2rem;
  font-family: 'VT323', 'Neoë‘¥ê·¼ëª¨', sans-serif;
  transition: all 0.3s ease;
  min-width: 120px;
  text-align: center;
}

.option-btn:hover {
  background-color: #ff00ff;
  border-color: #ff00ff;
  color: #fff;
  box-shadow: 0 0 10px #ff00ff;
  transform: translateY(-2px);
}

.option-btn:active {
  transform: translateY(0);
  box-shadow: 0 0 5px #ff00ff;
}

/* ë´‡ ë©”ì‹œì§€ì™€ ì‚¬ìš©ì ë©”ì‹œì§€ êµ¬ë¶„ */
.bot-message {
  color: #1e90ff;
  margin-bottom: 10px;
}

.user-message {
  color: #ffffff;
  margin-bottom: 10px;
  text-align: right;
}

/* íƒ€ì´í•‘ íš¨ê³¼ */
.typing-indicator {
  color: #0ff;
  animation: typing 1.4s infinite;
}

@keyframes typing {
  0%, 60%, 100% { opacity: 1; }
  30% { opacity: 0.3; }
} 
  </style>

</head>
<body>
  <!-- ì±•í„° ì„ íƒ ë²„íŠ¼ì€ ìˆ¨ê¸°ì§€ë§Œ ì‚­ì œí•˜ì§€ ì•ŠìŒ -->
  <div class="chapter-dropdown">
    <button id="chapterBtn" class="chapter-btn" onclick="toggleDropdown()">â–¼ Chapter ì„ íƒ</button>
    <div class="dropdown-content" id="chapterList">
      <div onclick="switchChapter(1)">Chapter 1</div>
      <div onclick="switchChapter(2)">Chapter 2</div>
    </div>
  </div>

  <h1>SAVE STEVE!</h1>
  <div class="game-container">
    <div class="content-container">
      <div class="gif-container">
        <img id="sceneImage" src="Save-steve.gif" alt="Game Image">
        <div class="status-container">
          <p id="statusText">ìƒíƒœ: ìŠ¤í‹°ë¸ŒëŠ” ì•„ë¬´ë ‡ì§€ ì•Šì€ ê²ƒ ê°™ìŠµë‹ˆë‹¤.</p>
        </div>
      </div>
      <div class="chat-container">
        <div class="response-box" id="responseBox"></div>
        <div class="input-container">
          <input type="text" class="prompt-input" id="promptInput" placeholder="í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”." onkeypress="handleKeyPress(event)" />
          <button class="submit-btn" onclick="generateResponse()">Send</button>
          <button class="reset-btn" onclick="resetChat()">Reset</button>
        </div>
      </div>
    </div>
  </div>

  <div id="chapter-transition-overlay">
    <div id="chapter-transition-text">CLEAR</div>
    <button id="next-chapter-btn">ë‹¤ìŒ ì±•í„°ë¡œ â–¶</button>
  </div>

<!-- ê²Œì„ ì˜¤ë²„ ì˜¤ë²„ë ˆì´ -->
<div id="game-over-overlay">
    <div id="game-over-text">GAME OVER</div>
    <div id="game-over-message">ìŠ¤í‹°ë¸Œë¥¼ í™”ë‚˜ê²Œ í•œ ê±´ ì•„ë‹ˆê² ì£ ?</div>
    <button id="game-over-retry-btn">ë‹¤ì‹œ ì‹œì‘</button>
</div>

<script>
    let hasKey = false;
    let boxOpened = false;
    let safeOpened = false;
    let currentChapter = 1;
    let nextChapterNumber = 2;
    let playerName = localStorage.getItem('playerName') || 'í”Œë ˆì´ì–´';
    let currentPlayerName = playerName; 
    let buttonInputMode = false;
    let buttonSequence = [];

    function setPlayerName(name) {
        if (name && name.trim() !== '') {
            playerName = name.trim();
            currentPlayerName = playerName;
            localStorage.setItem('playerName', playerName);
            console.log(`í”Œë ˆì´ì–´ ì´ë¦„ ì„¤ì •ë¨: ${playerName}`);
        }
    }

    function getPlayerName() {
        return playerName || 'í”Œë ˆì´ì–´';
    }

    // ì„œë²„ì—ì„œ í”Œë ˆì´ì–´ ì´ë¦„ì„ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
    async function fetchPlayerName() {
        try {
            const response = await fetch('/get-player-name');
            const data = await response.json();
            if (data.name) {
                currentPlayerName = data.name;
                playerName = data.name;
            }
        } catch (error) {
            console.log('í”Œë ˆì´ì–´ ì´ë¦„ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
        }
    }

    function showTextForFiveSeconds() {
        const textElement = document.createElement('div');
        textElement.className = 'text-overlay';
        textElement.textContent = `[${getPlayerName()}]`;
        textElement.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 16px;
            z-index: 1000;
            animation: fadeInOut 5s forwards;
        `;
        
        if (!document.querySelector('#textOverlayStyle')) {
            const style = document.createElement('style');
            style.id = 'textOverlayStyle';
            style.textContent = `
                @keyframes fadeInOut {
                    0% { opacity: 0; transform: translateX(20px); }
                    10% { opacity: 1; transform: translateX(0); }
                    90% { opacity: 1; transform: translateX(0); }
                    100% { opacity: 0; transform: translateX(20px); }
                }
            `;
            document.head.appendChild(style);
        }
        
        document.body.appendChild(textElement);
        setTimeout(() => {
            if (textElement.parentNode) {
                textElement.remove();
            }
        }, 5000);
    }

      const CH2 = 'https://test-room-1-9sdc.onrender.com';
      const CH3 = 'https://test-room-2.onrender.com';

function switchChapter(chapterNumber) {
  const name = encodeURIComponent(getPlayerName());

  if (chapterNumber === 2) {
    localStorage.setItem('playerName', getPlayerName());
    // í”Œë ˆì´ì–´ ì´ë¦„ì„ URL íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬í•˜ë„ë¡ ìˆ˜ì •
    window.location.href = `https://test-room-1-9sdc.onrender.com/?playerName=${name}`;
    return;
  }
  if (chapterNumber === 3) {
    localStorage.setItem('playerName', getPlayerName());
    window.location.href = `https://test-room-2.onrender.com/?playerName=${name}`;
    return;
  }
    
  currentChapter = chapterNumber;
  const chapterBtn = document.getElementById("chapterBtn");
  if (chapterBtn) {
    chapterBtn.textContent = `Chapter ${currentChapter}`;
  }
  const responseBox = document.getElementById("responseBox");
  if (responseBox) {
    responseBox.innerHTML = '';
  }
  displayMessage('SYSTEM', `ì±•í„° ${currentChapter}ë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'narration');
  hideDropdown();
  const sceneImage = document.getElementById("sceneImage");
  if (sceneImage) {
    sceneImage.src = 'Save-steve.gif';
  }
  updateStatusText('Save-steve.gif');
  hideOverlayAndTransition();

  showTextForFiveSeconds();
}

    function toggleDropdown() {
        const dropdown = document.getElementById("chapterList");
        if (dropdown) {
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        }
    }

    function hideDropdown() {
        const dropdown = document.getElementById("chapterList");
        if (dropdown) {
            dropdown.style.display = 'none';
        }
    }

    function updateStatusText(imageSrc) {
        const statusText = document.getElementById("statusText");
        const image = document.getElementById("sceneImage");

        if (!statusText || !image) return;

        let filename = imageSrc.split('/').pop().split('.')[0];
        
        console.log(`ì›ë³¸ imageSrc: ${imageSrc}`);
        console.log(`ì¶”ì¶œëœ filename: ${filename}`);

        if (filename === 'Save-steve') {
            image.src = `Save-steve.gif?v=${new Date().getTime()}`;
            statusText.textContent = 'ìƒíƒœ: ìŠ¤í‹°ë¸ŒëŠ” ì•„ë¬´ë ‡ì§€ ì•Šì€ ê²ƒ ê°™ìŠµë‹ˆë‹¤.';
            return;
        }

        let possiblePaths = [];
        
        if (imageSrc.includes('.gif') || imageSrc.includes('.png')) {
            possiblePaths.push(`${imageSrc}?v=${new Date().getTime()}`);
        }
        
        possiblePaths.push(`images/${filename}.gif?v=${new Date().getTime()}`);
        possiblePaths.push(`images/${filename}.png?v=${new Date().getTime()}`);
        possiblePaths.push(`${filename}.gif?v=${new Date().getTime()}`);
        possiblePaths.push(`${filename}.png?v=${new Date().getTime()}`);

        console.log('ì‹œë„í•  ê²½ë¡œë“¤:', possiblePaths);

        let currentPathIndex = 0;

        function tryLoadImage() {
            if (currentPathIndex >= possiblePaths.length) {
                console.log('ëª¨ë“  ê²½ë¡œì—ì„œ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨, ê¸°ë³¸ ì´ë¯¸ì§€ë¡œ ëŒ€ì²´');
                image.src = 'Save-steve.gif';
                statusText.textContent = 'ìƒíƒœ: ìŠ¤í‹°ë¸ŒëŠ” ì•„ë¬´ë ‡ì§€ ì•Šì€ ê²ƒ ê°™ìŠµë‹ˆë‹¤.';
                return;
            }

            const currentPath = possiblePaths[currentPathIndex];
            console.log(`ì‹œë„ ì¤‘ì¸ ê²½ë¡œ (${currentPathIndex + 1}/${possiblePaths.length}): ${currentPath}`);

            const testImage = new Image();
            
            testImage.onload = function() {
                console.log(`ì´ë¯¸ì§€ ë¡œë“œ ì„±ê³µ: ${currentPath}`);
                image.src = currentPath;
                updateStatusMessage(filename);
            };

            testImage.onerror = function() {
                console.log(`ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨: ${currentPath}`);
                currentPathIndex++;
                tryLoadImage();
            };

            testImage.src = currentPath;
        }

        tryLoadImage();

        function updateStatusMessage(filename) {
            switch (filename.toLowerCase()) {
                case 'ang': 
                    statusText.textContent = 'ìƒíƒœ: í™”ë‚¨'; 
                    break;
                case 'cold': 
                    statusText.textContent = 'ìƒíƒœ: ì¶”ì›€'; 
                    break;
                case 'hap': 
                    statusText.textContent = 'ìƒíƒœ: í–‰ë³µ'; 
                    break;
                case 'sad': 
                    statusText.textContent = 'ìƒíƒœ: ìŠ¬í””'; 
                    break;
                case 'sup': 
                    statusText.textContent = 'ìƒíƒœ: ë†€ëŒ'; 
                    break;
                default: 
                    statusText.textContent = 'ìƒíƒœ: ìŠ¤í‹°ë¸ŒëŠ” ì•„ë¬´ë ‡ì§€ ì•Šì€ ê²ƒ ê°™ìŠµë‹ˆë‹¤.';
            }
        }
    }

    function resetChat() {
        currentChapter = 1;
        boxOpened = false;
        hasKey = false;
        const responseBox = document.getElementById("responseBox");
        if (responseBox) {
            responseBox.innerHTML = '';
        }
        const sceneImage = document.getElementById("sceneImage");
        if (sceneImage) {
            sceneImage.src = 'Save-steve.gif';
        }
        updateStatusText('Save-steve.gif');
        displayMessage('SYSTEM', 'ì´ˆê¸°í™” ì™„ë£Œ.', 'narration');
        hideDropdown();
        hideOverlayAndTransition();
    }

    function displayMessage(author, message, className) {
        const responseBox = document.getElementById("responseBox");
        if (!responseBox) return;

        const messageElement = document.createElement("p");
        messageElement.className = `message ${className || 'bot-message'}`;
        
        if (className) {
            messageElement.innerHTML = `<strong>${author}:</strong> ${message}`;
        } else {
            const isUser = message;
            const actualMessage = author;
            messageElement.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
            
            if (isUser) {
                messageElement.innerHTML = `<strong>${currentPlayerName}:</strong> ${actualMessage}`;
            } else {
                messageElement.innerHTML = `<strong>ìŠ¤í‹°ë¸Œ:</strong> ${actualMessage}`;
            }
        }
        
        responseBox.appendChild(messageElement);
        responseBox.scrollTop = responseBox.scrollHeight;
    }

    function displayOptions(options) {
        const responseBox = document.getElementById('responseBox');
        if (!responseBox) return;

        const optionsDiv = document.createElement('div');
        optionsDiv.className = 'message-options';
        
        options.forEach(option => {
            const button = document.createElement('button');
            button.className = 'option-btn';
            button.textContent = option.text;
            button.onclick = () => handleOptionClick(option.action, option.text);
            optionsDiv.appendChild(button);
        });
        
        responseBox.appendChild(optionsDiv);
        responseBox.scrollTop = responseBox.scrollHeight;
    }

function handleOptionClick(action, buttonText) {
    if (action === 'openBox' || action === 'dontOpenBox') {
        displayMessage(buttonText, true);
        
        const optionContainers = document.querySelectorAll('.message-options');
        optionContainers.forEach(container => container.remove());
        
        sendMessage(action);
        return;
    }

    if (action.startsWith('button_') && ['button_ë³„', 'button_ë„¤ëª¨', 'button_ë™ê·¸ë¼ë¯¸', 'button_ì„¸ëª¨'].includes(action)) {
        buttonInputMode = true;
        
        const symbolMap = {
            'button_ë³„': 'â˜…',
            'button_ë„¤ëª¨': 'â– ', 
            'button_ë™ê·¸ë¼ë¯¸': 'â—',
            'button_ì„¸ëª¨': 'â–²'
        };
        
        const symbol = symbolMap[action];
        if (symbol) {
            buttonSequence.push(symbol);
            
            const promptInput = document.getElementById("promptInput");
            if (promptInput) {
                promptInput.value = buttonSequence.join('');
            }
        }
        
        sendButtonToServer(action);
        return;
    }
    
    if (action === 'button_submit') {
        const finalSequence = buttonSequence.join(' ');
        
        displayMessage(finalSequence, true);
        
        const promptInput = document.getElementById("promptInput");
        if (promptInput) {
            promptInput.value = '';
        }
        
        buttonInputMode = false;
        buttonSequence = [];
        
        const optionContainers = document.querySelectorAll('.message-options');
        optionContainers.forEach(container => container.remove());
        
        sendMessage(action);
        return;
    }
    
    if (action === 'button_reset') {
        buttonSequence = [];
        
        const promptInput = document.getElementById("promptInput");
        if (promptInput) {
            promptInput.value = '';
        }
        
        sendMessage(action);
        return;
    }
    
    if (!action.startsWith('button_')) {
        displayMessage(buttonText, true);
    }
    
    const optionContainers = document.querySelectorAll('.message-options');
    optionContainers.forEach(container => container.remove());
    
    sendMessage(action);
}

async function sendButtonToServer(action) {
    try {
        const response = await fetch('/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                message: action,
                name: getPlayerName()
            }),
        });

        const data = await response.json();
        console.log(`${action} ì„œë²„ ì „ì†¡ ì™„ë£Œ:`, data);
        
    } catch (error) {
        console.error('ë²„íŠ¼ ì„œë²„ ì „ì†¡ ì˜¤ë¥˜:', error);
    }
}

function forceSuccessOnCorrectSequence() {
    console.log('ğŸ”¥ forceSuccessOnCorrectSequence í•¨ìˆ˜ í˜¸ì¶œë¨ (í˜„ì¬ëŠ” ë¹„í™œì„±í™”)');
}

    function showTypingIndicator() {
        const responseBox = document.getElementById('responseBox');
        if (!responseBox) return;

        const typingDiv = document.createElement('div');
        typingDiv.className = 'message bot-message typing-indicator';
        typingDiv.id = 'typing-indicator';
        typingDiv.innerHTML = '<strong>ìŠ¤í‹°ë¸Œ:</strong> ...';
        responseBox.appendChild(typingDiv);
        responseBox.scrollTop = responseBox.scrollHeight;
    }

    function hideTypingIndicator() {
        const typingIndicator = document.getElementById('typing-indicator');
        if (typingIndicator) {
            typingIndicator.remove();
        }
    }

async function sendMessage(message) {
    const currentName = getPlayerName();
  
    try {
        showTypingIndicator();
        
        const response = await fetch('/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                message: message,
                name: currentName
            }),
        });

        const data = await response.json();
        
        hideTypingIndicator();
        
        console.log('ğŸ“ data.message íƒ€ì…:', typeof data.message);
        console.log('ğŸ“ data.message ê°’:', data.message);
        console.log('ğŸ“ data.clear:', data.clear);
        
        if (data.message) {
            if (Array.isArray(data.message)) {
                data.message.forEach(msg => {
                    if (msg && msg.text) {
                        if (msg.type === 'steve') {
                            displayMessage(msg.text, false);
                        } else if (msg.type === 'narration') {
                            displayMessage('SYSTEM', msg.text, 'narration');
                        } else if (msg.type === 'user') {
                            displayMessage(msg.text, true);
                        }
                    }
                });
            } else if (typeof data.message === 'string' && data.message.trim() !== '') {
                displayMessage(data.message, false);
            }
        }
        
        if (data.image) {
            updateStatusText(data.image);
        }
        
        if (data.options && data.options.length > 0) {
            displayOptions(data.options);
        }
        
        if (data.forceNote) {
            console.log('ğŸ”¥ ìª½ì§€ ê°•ì œ í‘œì‹œ í”Œë˜ê·¸ ê°ì§€!');
        }
        
        if (data.clear) {
            console.log('ğŸ”¥ í´ë¦¬ì–´ í”Œë˜ê·¸ ê°ì§€! ë‹¤ìŒ ì±•í„°ë¡œ ì „í™˜í•©ë‹ˆë‹¤.');
            setTimeout(() => {
                showOverlayAndButton(currentChapter + 1);
            }, 2000);
        }
        
        if (typeof data.message === 'string') {
            if (data.message.includes('ì±…ì¥ì´... ë¬¸ì´ì˜€ë„¤ìš”') || 
                data.message.includes('ë“œë””ì–´ íƒˆì¶œí•  ìˆ˜ ìˆì„ ê²ƒ ê°™ì•„ìš”') ||
                data.message.includes('íƒˆì¶œì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤')) {
                console.log('ğŸ”¥ ë©”ì‹œì§€ ë‚´ìš©ìœ¼ë¡œ ì±•í„° ì „í™˜ ê°ì§€!');
                setTimeout(() => {
                    showOverlayAndButton(currentChapter + 1);
                }, 2000);
            }
        } else if (Array.isArray(data.message)) {
            const hasChapterTransition = data.message.some(msg => 
                msg && msg.text && (
                    msg.text.includes('ì±…ì¥ì´... ë¬¸ì´ì˜€ë„¤ìš”') ||
                    msg.text.includes('ë“œë””ì–´ íƒˆì¶œí•  ìˆ˜ ìˆì„ ê²ƒ ê°™ì•„ìš”') ||
                    msg.text.includes('íƒˆì¶œì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤')
                )
            );
            if (hasChapterTransition) {
                console.log('ğŸ”¥ ë°°ì—´ ë©”ì‹œì§€ì—ì„œ ì±•í„° ì „í™˜ ê°ì§€!');
                setTimeout(() => {
                    showOverlayAndButton(currentChapter + 1);
                }, 2000);
            }
        }
        
        // ê²Œì„ ì˜¤ë²„ ì²˜ë¦¬
        if (typeof data.message === 'string' && data.message.includes('ëŒ€í™”ë¥¼ ì´ì–´ê°ˆ ìˆ˜ ì—†ë‹¤ëŠ” ê²Œ ìŠ¬í”„ë„¤ìš”')) {
            setTimeout(() => {
                showGameOverScreen();
            }, 2000);
        } else if (Array.isArray(data.message)) {
            const hasGameOver = data.message.some(msg => 
                msg && msg.type === 'steve' && typeof msg.text === 'string' && msg.text.includes('ëŒ€í™”ë¥¼ ì´ì–´ê°ˆ ìˆ˜ ì—†ë‹¤ëŠ” ê²Œ ìŠ¬í”„ë„¤ìš”')
            );
            if (hasGameOver) {
                setTimeout(() => {
                    showGameOverScreen();
                }, 2000);
            }
        }
        
    } catch (error) {
        hideTypingIndicator();
        console.error('Error:', error);
        displayMessage('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', false);
    }
}

    async function generateResponse() {
        const promptInput = document.getElementById("promptInput");
        if (!promptInput) return;

        const message = promptInput.value.trim();
        if (!message) return;

        displayMessage(message, true);
        promptInput.value = '';

        if (message.toLowerCase() === 'reset') {
            resetChat();
            return;
        }

        if (message.includes('0')) {
            displayMessage('ìŠ¤í‹°ë¸Œ', 'ë‹¤ìŒìœ¼ë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤. ë‹¹ì‹ ì€ ì´ë¯¸ í”Œë ˆì´ë¥¼ í•´ë³¸ì ì´ ìˆë‚˜ìš”?', 'steve');
            await new Promise(r => setTimeout(r, 2000));
            showOverlayAndButton(currentChapter + 1);
            return;
        }

        if (message.includes('ì—´ì')) {
            displayMessage('ë‚˜ë ˆì´ì…˜', 'ë¬¸ì´ ì—´ë ¸ìŠµë‹ˆë‹¤. ë‹¤ìŒ ë°©ìœ¼ë¡œ ì´ë™í•´ì£¼ì„¸ìš”.', 'narration');
            await new Promise(r => setTimeout(r, 2000));
            showOverlayAndButton(currentChapter + 1);
            return;
        }

        const keyKeywords = ["ì—´ì‡ ", "í‚¤", "key"];
        const doorKeywords = ["ë¬¸ ì—´ê¸°", "ë¬¸ì„ ì—´ë‹¤", "ë¬¸ ì—´ì–´", "ë¬¸ì„ ì—´ì–´", "ë¬¸ì„ ì—´ì–´ë¼", "ì—´ì‡ ë¡œ ë¬¸ì„", "ì—´ì‡ ë¡œ ë¬¸ ì—´ê¸°"];
        
        if (keyKeywords.some(keyword => message.toLowerCase().includes(keyword)) && safeOpened && !hasKey) {
            hasKey = true;
            displayMessage('ìŠ¤í‹°ë¸Œ', 'ì—´ì‡ ë¥¼ ì°¾ì•˜ì–´ìš”! ì´ì œ ë¬¸ì„ ì—´ ìˆ˜ ìˆì„ ê²ƒ ê°™ìŠµë‹ˆë‹¤.', 'steve');
            return;
        }
        
        if (doorKeywords.some(keyword => message.includes(keyword)) && hasKey) {
            displayMessage('ìŠ¤í‹°ë¸Œ', 'ì—´ì‡ ë¡œ ë¬¸ì„ ì—´ì—ˆì–´ìš”! ìš°ë¦¬ëŠ” íƒˆì¶œì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤!', 'steve');
            setTimeout(() => showOverlayAndButton(2), 1500);
            return;
        }

        try {
            const res = await fetch('/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    message, 
                    name: getPlayerName()
                })
            });

            const data = await res.json();

            if (!Array.isArray(data.message)) {
                displayMessage('ìŠ¤í‹°ë¸Œ', data.message, 'steve');
                
                if (data.message === "ëŒ€í™”ë¥¼ ì´ì–´ê°ˆ ìˆ˜ ì—†ë‹¤ëŠ” ê²Œ ìŠ¬í”„ë„¤ìš”.") {
                    setTimeout(() => showGameOverScreen(), 1000);
                }
                
                if (data.options) {
                    displayOptions(data.options);
                }
            } else {
                data.message.forEach((msg) => {
                    const role = msg.type === 'narration' ? 'narration' : 'steve';
                    displayMessage(msg.type === 'narration' ? 'SYSTEM' : 'ìŠ¤í‹°ë¸Œ', msg.text, role);

                    if (msg.type === 'steve' && (
                        msg.text.includes('ë¬¸ì´ ì—´ë ¸ì–´ìš”') || 
                        msg.text.includes('ë¬¸ì´ ì—´ë¦° ê²ƒ ê°™ì•„ìš”') ||
                        msg.text.includes('ë¬¸ì´ ì—´ë¦°')
                    )) {
                        setTimeout(() => showOverlayAndButton(2), 1000);
                    }
                    
                    if (msg.type === 'steve' && msg.text.includes('ì±…ì¥ì´... ë¬¸ì´ì˜€ë„¤ìš”...! ì €ê¸° ë­ê°€ ë³´ì´ëŠ” ê²ƒ ê°™ì€ë°ìš”?')) {
                        setTimeout(() => showOverlayAndButton(3), 1000);
                    }
                    
                    if (msg.type === 'steve' && msg.text === "ëŒ€í™”ë¥¼ ì´ì–´ê°ˆ ìˆ˜ ì—†ë‹¤ëŠ” ê²Œ ìŠ¬í”„ë„¤ìš”.") {
                        setTimeout(() => showGameOverScreen(), 1000);
                    }
                });
            }

            if (data.image) {
                updateStatusText(data.image);
            }
        } catch (err) {
            console.error('Error:', err);
            displayMessage('SYSTEM', 'ì„œë²„ ì—°ê²° ì‹¤íŒ¨', 'narration');
        }
    }

    function handleKeyPress(event) {
        if (event.key === 'Enter') {
            generateResponse();
        }
    }

function showOverlayAndButton(chapterNumber) {
    console.log(`ğŸ”¥ showOverlayAndButton í˜¸ì¶œë¨: ${chapterNumber}`);
    
    nextChapterNumber = chapterNumber;
    const overlay = document.getElementById("chapter-transition-overlay");
    const text = document.getElementById("chapter-transition-text");

    if (overlay) {
        console.log(`ğŸ”¥ ì˜¤ë²„ë ˆì´ í‘œì‹œ ì‹œì‘`);
        overlay.style.display = 'flex';
        setTimeout(() => {
            overlay.style.opacity = 1;
            overlay.style.pointerEvents = 'auto';
            
            if (text) {
                text.style.animation = 'none';
                text.offsetHeight;
                text.style.animation = 'slideIn 1.5s forwards';
            }
        }, 10);
    } else {
        console.error('ğŸ”¥ chapter-transition-overlay ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
    }
}

    function hideOverlayAndTransition() {
        const overlay = document.getElementById("chapter-transition-overlay");
        if (overlay) {
            overlay.style.opacity = 0;
            overlay.style.pointerEvents = 'none';
            
            setTimeout(() => {
                overlay.style.display = 'none';
                const text = document.getElementById("chapter-transition-text");
                if (text) {
                    text.style.animation = 'none';
                    text.style.transform = 'translateY(100%)';
                    text.style.opacity = 0;
                }
            }, 500);
        }
    }

    function showClearScreen() {
        const overlay = document.getElementById("chapter-transition-overlay");
        const text = document.getElementById("chapter-transition-text");
        const nextBtn = document.getElementById("next-chapter-btn");
        
        if (text) text.textContent = "CLEAR";
        if (nextBtn) nextBtn.textContent = "ë‹¤ìŒ ì±•í„°ë¡œ â–¶";
        
        if (overlay) {
            overlay.classList.add('clear-screen');
            overlay.style.display = 'flex';
            setTimeout(() => {
                overlay.style.opacity = 1;
                overlay.style.pointerEvents = 'auto';
                
                if (text) {
                    text.style.animation = 'none';
                    text.offsetHeight;
                    text.style.animation = 'slideIn 1.5s forwards';
                }
            }, 10);
        }
    }

    function showGameOverScreen() {
        console.log('ê²Œì„ ì˜¤ë²„ í™”ë©´ í‘œì‹œ ì‹œë„');
        
        const existingOverlay = document.querySelector('.game-over-screen');
        if (existingOverlay) {
            existingOverlay.remove();
        }
        
        const gameOverScreen = document.createElement('div');
        gameOverScreen.className = 'game-over-screen';
        gameOverScreen.style.cssText = `
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            background: rgba(0, 0, 0, 0.95) !important;
            display: flex !important;
            flex-direction: column !important;
            justify-content: center !important;
            align-items: center !important;
            z-index: 999999 !important;
            font-family: 'VT323', monospace !important;
        `;
        
        gameOverScreen.innerHTML = `
            <div style="
                font-size: 80px !important;
                color: #FF4C4C !important;
                text-shadow: 0 0 10px #FF4C4C, 0 0 20px #FF4C4C !important;
                margin-bottom: 20px !important;
                font-family: 'VT323', monospace !important;
                text-align: center !important;
            ">GAME OVER</div>
            <div style="
                font-size: 24px !important;
                color: #FF4C4C !important;
                margin-bottom: 30px !important;
                text-shadow: 0 0 5px #FF4C4C !important;
                font-family: 'VT323', monospace !important;
                text-align: center !important;
            ">ìŠ¤í‹°ë¸Œë¥¼ í™”ë‚˜ê²Œ í•œ ê±´ ì•„ë‹ˆê² ì£ ?</div>
            <button onclick="location.reload()" style="
                margin-top: 40px !important;
                padding: 15px 30px !important;
                font-family: 'VT323', monospace !important;
                font-size: 1.5rem !important;
                background: #FF4C4C !important;
                color: #000 !important;
                border: 2px solid #FF4C4C !important;
                border-radius: 5px !important;
                cursor: pointer !important;
                transition: all 0.3s !important;
            " onmouseover="this.style.background='#fff'; this.style.color='#FF4C4C';" 
               onmouseout="this.style.background='#FF4C4C'; this.style.color='#000';">ë‹¤ì‹œ ì‹œì‘</button>
        `;
        
        document.body.appendChild(gameOverScreen);
        console.log('ê²Œì„ ì˜¤ë²„ í™”ë©´ ìƒì„± ì™„ë£Œ');
    }

    window.onload = async () => {
        const storedName = localStorage.getItem('playerName');
        if (storedName && storedName !== 'í”Œë ˆì´ì–´') {
            playerName = storedName;
            currentPlayerName = storedName;
            showTextForFiveSeconds();
        }
        
        await fetchPlayerName();
        
        try {
            const response = await fetch('/sync-name', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: getPlayerName() })
            });
            const data = await response.json();
            if (data.success) {
                console.log('ì„œë²„ì™€ í”Œë ˆì´ì–´ ì´ë¦„ ë™ê¸°í™” ì™„ë£Œ');
            }
        } catch (error) {
            console.log('ì„œë²„ ë™ê¸°í™” ì‹¤íŒ¨ (ì •ìƒ ë™ì‘)', error.message);
        }
    };

    document.addEventListener('DOMContentLoaded', () => {
        fetchPlayerName();
        
            document.getElementById("next-chapter-btn").addEventListener("click", () => {
        const name = encodeURIComponent(getPlayerName());
        window.location.href = `https://test-room-1-9sdc.onrender.com/?playerName=${name}`;
    });

        const gameOverRetryBtn = document.getElementById('game-over-retry-btn');
        if (gameOverRetryBtn) {
            gameOverRetryBtn.onclick = function() {
                fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message: 'reset' }),
                }).then(() => {
                    location.reload();
                });
            };
        }
    });

    document.addEventListener('DOMContentLoaded', async function() {
        const urlParams = new URLSearchParams(window.location.search);
        const nameFromUrl = urlParams.get('playerName');
        
        if (nameFromUrl && nameFromUrl.trim() !== '' && nameFromUrl !== 'í”Œë ˆì´ì–´') {
            const decodedName = decodeURIComponent(nameFromUrl);
            console.log(`ğŸ“¥ URLì—ì„œ ì´ë¦„ ë¡œë“œ: ${decodedName}`);
            
            try {
                const response = await fetch('/sync-name', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: decodedName })
                });
                
                if (response.ok) {
                    console.log('âœ… ì„œë²„ ì´ë¦„ ë™ê¸°í™” ì„±ê³µ');
                    if (typeof setCurrentPlayerName === 'function') {
                        setCurrentPlayerName(decodedName);
                    }
                }
            } catch (error) {
                console.log('âŒ ì„œë²„ ì´ë¦„ ë™ê¸°í™” ì‹¤íŒ¨:', error);
            }
        }
    });

    window.gameUtils = {
        setPlayerName,
        getPlayerName,
        showTextForFiveSeconds
    };
</script>
</body>
</html>
