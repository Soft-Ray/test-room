<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="preload" href="https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2107@1.1/NeoDunggeunmo.woff" as="font" type="font/woff" crossorigin>
  <title>이름 입력 화면</title>
  <style>
    @font-face {
      font-family: 'NeoDunggeunmo';
      src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2107@1.1/NeoDunggeunmo.woff') format('woff');
      font-weight: normal;
      font-style: normal;
      font-display: swap;
    }

    * {
      font-family: 'NeoDunggeunmo', 'Courier New', 'Malgun Gothic', '맑은 고딕', monospace, sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background-color: black;
      color: white;
    }

    .name-input-container {
      text-align: center;
      font-size: 2vw;
    }

    .input-group {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
      width: 100%;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }

    .name-input-container input {
      padding: 10px;
      font-size: 1.2vw;
      border-radius: 5px;
      border: none;
      min-width: 200px;
      flex: 1;
    }

    .name-submit-btn {
      padding: 10px 20px;
      font-size: 1.2vw;
      border: none;
      background-color: #ffcc00;
      color: #000;
      border-radius: 5px;
      cursor: pointer;
    }

    .name-submit-btn:disabled {
      background-color: #666;
      cursor: not-allowed;
    }

    .loading {
      margin-top: 20px;
      color: #ffcc00;
      font-size: 1vw;
    }

    .status {
      margin-top: 10px;
      font-size: 0.8vw;
      color: #ccc;
    }

    /* 로딩바 */
    .loading-bar-container {
      margin-top: 10px;
      height: 30px;
      position: relative;
      display: none;
      width: 100%;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }

    .progress-bar-container {
      width: 100%;
      height: 4px;
      background: #333;
      border-radius: 2px;
      overflow: hidden;
    }

    .progress-bar {
      height: 100%;
      background: #00eeff;
      width: 0%;
      transition: width 0.3s ease;
      border-radius: 2px;
    }

    .progress-text {
      text-align: right;
      margin-top: 5px;
      font-size: 12px;
      color: #ccc;
    }

    /* ✅ sup.gif 스타일 추가 */
    .sup-gif {
      display: none;
      width: 60%;
      max-width: 250px;/* 로딩 바와 동일한 폭 */
      margin: 15px auto 0 auto;
      opacity: 0;
      transition: opacity 0.8s ease;
    }
    .sup-gif.show {
      display: block;
      opacity: 1;
    }
  </style>
</head>
<body>
  <div class="name-input-container" id="name-input-container">
    <div>
      <label for="name">이름을 입력해주세요</label>
      <br><br>
      <div class="input-group">
        <input type="text" id="name" placeholder="이름 입력" />
        <button class="name-submit-btn" id="name-submit-btn">확인</button>
      </div>
      <div class="loading" id="loading" style="display: none;">
        서버 연결 중...
      </div>
      <div class="status" id="status"></div>

      <div class="loading-bar-container" id="loading-bar-container">
        <div class="progress-bar-container">
          <div class="progress-bar" id="progress-bar"></div>
        </div>
        <div class="progress-text" id="progress-text">0%</div>

        <!-- ✅ sup.gif 추가 -->
        <img src="sup.gif" alt="로딩 이미지" id="sup-gif" class="sup-gif" />
      </div>
    </div>
  </div>

<script>
  const nameSubmitBtn = document.getElementById('name-submit-btn');
  const nameInput = document.getElementById('name');
  const loading = document.getElementById('loading');
  const status = document.getElementById('status');
  const loadingBarContainer = document.getElementById('loading-bar-container');
  const progressBar = document.getElementById('progress-bar');
  const progressText = document.getElementById('progress-text');
  const supGif = document.getElementById('sup-gif'); // ✅ 추가

  let savedPlayerName = '플레이어';
  let supGifTimeout; // ✅ 타이머 변수

  // ✅ 로딩 문구 순환
  const loadingMessages = [
    "이름을 각 챕터에 전송하고 있습니다...",
    "스티브와 연결을 시도하고 있습니다...",
    "서버 응답을 대기하고 있습니다...",
    "조금만 기다려주세요...",
    "스티브는 당신이 누군지 알고 있을까요?...",
    "당신의 질문에 따라 결과가 달라질지 몰라요...",
    "지금 스티브는 무엇을 하고 있을까요?",
    "긍정이 당신을 진실로 데려가줄지도 모르죠...",
    "채팅이 시작되면, 스티브에게 인사를 해보세요",
    "보다 정확한 요구는 스티브를 움직이게 만들거예요...",
    "탈출이 꼭 필요할까요...?",
    "마지막 데이터 확인 중..."
  ];

  let loadingMessageIndex = 0;
  let loadingInterval;

  function startLoadingMessages() {
    loading.style.display = 'block';
    loading.textContent = loadingMessages[loadingMessageIndex];
    loadingInterval = setInterval(() => {
      loadingMessageIndex = (loadingMessageIndex + 1) % loadingMessages.length;
      loading.textContent = loadingMessages[loadingMessageIndex];
    }, 4000);

    // ✅ 2초 뒤 sup.gif 표시
    supGifTimeout = setTimeout(() => {
      supGif.classList.add('show');
    }, 2000);
  }

  function stopLoadingMessages() {
    clearInterval(loadingInterval);
    clearTimeout(supGifTimeout);
    loading.style.display = 'none';
    supGif.classList.remove('show');
  }

  function updateProgressBar(progress) {
    progressBar.style.width = `${progress}%`;
    progressText.textContent = `${Math.round(progress)}%`;
  }

  async function sendNameToAllServers(name) {
    const servers = [
      { url: 'https://test-room-o4yh.onrender.com/set-name', name: 'Server 1' },
      { url: 'https://test-room-1-9sdc.onrender.com/set-name', name: 'Server 2' },
      { url: 'https://test-room-2.onrender.com/set-name', name: 'Server 3' }
    ];

    const results = [];
    const totalServers = servers.length;

    for (let i = 0; i < servers.length; i++) {
      const server = servers[i];
      const progress = (i / totalServers) * 100;

      try {
        status.textContent = `${server.name}에 전송 중...`;
        updateProgressBar(progress);
        const response = await fetch(server.url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: name })
        });

        if (response.ok) {
          results.push({ server: server.name, success: true });
        } else {
          results.push({ server: server.name, success: false });
        }
      } catch {
        results.push({ server: server.name, success: false });
      }
      await new Promise(res => setTimeout(res, 500));
    }

    updateProgressBar(100);
    return results;
  }

  async function syncNameToAllServers(name) {
    const servers = [
      'https://test-room-o4yh.onrender.com/sync-name',
      'https://test-room-1-9sdc.onrender.com/sync-name',
      'https://test-room-2.onrender.com/sync-name'
    ];

    await Promise.allSettled(servers.map(url =>
      fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name })
      })
    ));
  }

  nameSubmitBtn.addEventListener('click', async () => {
    const name = nameInput.value.trim();
    if (!name || name === '플레이어') {
      alert('유효한 이름을 입력해주세요.');
      return;
    }

    nameSubmitBtn.disabled = true;
    nameSubmitBtn.textContent = '전송 중...';
    startLoadingMessages();
    loadingBarContainer.style.display = 'block';

    try {
      savedPlayerName = name;
      const results = await sendNameToAllServers(name);
      await syncNameToAllServers(name);

      const successCount = results.filter(r => r.success).length;

      if (successCount > 0) {
        status.textContent = `${successCount}개 서버에 성공적으로 전송됨`;
        status.style.color = '#90EE90';
      } else {
        status.textContent = '서버 연결 실패했지만 게임을 시작합니다.';
        status.style.color = '#FFB6C1';
      }

      setTimeout(() => {
        window.location.href = `https://test-room-o4yh.onrender.com?playerName=${encodeURIComponent(name)}`;
      }, 2000);

    } catch (e) {
      status.textContent = '오류 발생했지만 게임을 시작합니다.';
      status.style.color = '#FFB6C1';
      setTimeout(() => {
        window.location.href = `https://test-room-o4yh.onrender.com?playerName=${encodeURIComponent(name)}`;
      }, 2000);
    } finally {
      stopLoadingMessages();
      setTimeout(() => {
        loadingBarContainer.style.display = 'none';
        nameSubmitBtn.disabled = false;
        nameSubmitBtn.textContent = '확인';
      }, 5000);
    }
  });

  nameInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !nameSubmitBtn.disabled) {
      nameSubmitBtn.click();
    }
  });
</script>
</body>
</html>
